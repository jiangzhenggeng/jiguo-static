define(["jquery","layer","app/tplEngine","app/provinceArea"],function(a,b,c,d){b.ready(),a(function(){function d(d){var d=a.extend({title:"添加地址",data:{},url:"/api/user/AddRess",tpl:"#add-addr-tpl",province:"北京",city:"北京市",country:"海淀区"},d),e=c.init(a(d.tpl).html(),{data:d.data});b.open({type:1,title:d.title,closeBtn:1,shadeClose:!0,area:["500px","380px"],content:e,success:function(c,e){var f=a("#addrFormData");a(c).find(".btn").click(function(){if(a(c).find("#username").val()==""||a(c).find("#username").val().length<2){b.msg("请填写姓名");return}if(!/^1[2-9][0-9]{9}$/.test(a(c).find("#tel").val())){b.msg("请填写正确的手机号");return}if(a(c).find("#city").val()==""){b.msg("请填写省市");return}if(a(c).find("#address").val()==""){b.msg("请填写详细地址");return}var e=f.serialize();a.post(d.url,e,function(a){a.resultCode==0?window.location.reload():b.msg(a.errorMsg||"系统错误")},"json")});var g=a("#country");AreaSelector({selProvinceId:"province",selCityId:"city",selAreaId:"country",onProvinceChange:function(){},onCityChange:function(){if(g.find("option").length<=1){var a=g.parent().prev().find("#city").val(),b='<option value="'+a+'">'+a+"</option>>";g.append(b)}}}).initProvince(d.province,d.city,d.country);if(g.find("option").length<=1){var h=g.parent().prev().find("#city").val(),i='<option value="'+h+'" selected="selected">'+h+"</option>>";g.append(i)}}})}a("[data-edit-addr]").click(function(){var c=a(this);a.get("/api/user/GetAddress",{id:c.attr("data-id")},function(a){a.resultCode!=0?b.msg("系统错误"):d({data:a.result,title:"修改地址",url:"/api/user/EditAddress",tpl:"#add-addr-edit-tpl",province:a.result.province,city:a.result.city,country:a.result.country})},"json")}),a("[data-default-addr]").click(function(){var c=a(this);a(this).prop("checked")&&a.get("/api/user/SetAddress",{id:a(this).attr("data-id")},function(a){a.resultCode!=0&&(b.msg("系统错误"),c.prop("checked",!1))},"json")}),a("[data-delete-addr]").click(function(){var c=a(this);b.alert("您确定删除吗?",function(){a.get("/api/user/DelAddress",{id:c.attr("data-id")},function(d){d.resultCode!=0?b.msg("系统错误"):(c.parent().parent().fadeOut(250,function(){a(this).remove()}),b.closeAll())},"json")})}),a("#add-addr").click(function(){d()})})})
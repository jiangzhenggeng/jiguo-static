define(["jquery","app/tplEngine","app/unitTool","layer"],function(a,b,c,d){return{searchAll:function(e,f,g){function h(b,c){var d=this,e=String(d.keyword).replace(/^\s+|\s+$/i,"");if(d.loading)return;d.loading=!0;var f=a("title").html(),g=u(window.location.href);history.pushState({title:f},f,g),q.show(),p.hide(),r.hide(),a.get("/api/search/index",{keyword:e,type:d.type,cid:d.cid,limit:d.limit,sys:d.sys,size:d.size},function(a){d.loading=!1,q.hide(),d.limit=a.limit,b.apply(d,[a,c])},"json")}function m(a){j.limit=a||0,j.keyword=j.val(),h.apply(j,[t,!0,a]),k.html(j.keyword)}function t(a,b,e){var f=!0,g=0,h=this;if(a.resultCode==0)for(var i=0;i<n.length;i++){g=c.getLength(a.result[n[i]]);if(g>0){o[i].warpBox.show();if(o[i].htmlBox.length){f=!1,b&&e<=0?o[i].htmlBox.html(o[i].cacheFn({data:a.result[n[i]]})):o[i].htmlBox.append(o[i].cacheFn({data:a.result[n[i]]})),g<h.size?(r.hide(),j.type?(f=!0,p.show()):p.hide()):j.type?(r.show(),p.hide()):(p.hide(),r.hide());if(j.type)break}}else e<=0&&o[i].warpBox.hide();o[i].warpBox.attr("data-number",c.getLength(a.result[n[i]]))}else d.msg(a.message||"系统错误");f?p.show():p.hide()}function u(a){var b=a.split("?");return b.length>=2&&b[1]!=""?(b[1]=String(b[1]).replace(/keyword=([^&]*)/i,"").replace(/^&+|&+$/i,""),a=b[0]+"?"+b[1]+"&keyword="+j.val(),a.replace(/^&+|&+$/i,"")):a}var i=a(".search-page-header"),j=i.find("#keyword"),k=a("#show-keyword"),l=null;j.loading=!1,i.on("click","[data-search-page-submit]",function(){j.keyword=j.val(),j.limit=0,h.apply(j,[t,!0])}).on("keyup","#keyword",function(){clearTimeout(l),l=setTimeout(m,500)}),j.type=e,j.cid=f,j.sys="pc",j.limit=g||"0",j.size=8;var n=["event","product","rebate","list","article"],o=[],p=a(".no-data"),q=a(".loading"),r=a(".click-loading");j.type&&(j.size=20);for(var s=0;s<n.length;s++)o.push({cacheFn:b.init(a("#"+n[s]+"AjaxLoad-tpl").html()),htmlBox:a("#"+n[s]+"AjaxLoad"),warpBox:a("#"+n[s]+"Warp")});m(g),r.click(function(){h.apply(j,[t,!1])}),a("a[href][data-search-singin-url]").click(function(b){a(this).attr("href",u(a(this).attr("href")))})}}})
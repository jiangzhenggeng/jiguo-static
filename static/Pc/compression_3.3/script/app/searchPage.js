define(["jquery","app/tplEngine","app/unitTool","layer"],function(a,b,c,d){return{searchAll:function(e,f){function g(b,c){var d=this,e=String(d.keyword).replace(/^\s+|\s+$/i,"");if(d.loading)return;d.loading=!0;var f=a("title").html(),g=j(window.location.href);history.pushState({title:f},f,g),r.show(),q.hide(),s.hide(),a.get("/api/search/index",{keyword:e,type:d.type,cid:d.cid,limit:d.limit,sys:d.sys,size:d.size},function(a){d.loading=!1,r.hide(),d.limit=a.limit,b.apply(d,[a,c])},"json")}function h(){l.limit=0,l.keyword=l.val(),g.apply(l,[i,!0]),m.html(l.keyword)}function i(a,b){var e=!0,f=0,g=this;if(a.resultCode==0)for(var h=0;h<o.length;h++){f=c.getLength(a.result[o[h]]);if(f>0){p[h].warpBox.show();if(p[h].htmlBox.length){e=!1,b?p[h].htmlBox.html(p[h].cacheFn({data:a.result[o[h]]})):p[h].htmlBox.append(p[h].cacheFn({data:a.result[o[h]]})),f<g.size?(s.hide(),l.type?(e=!0,q.show()):q.hide()):l.type?(s.show(),q.hide()):(q.hide(),s.hide());if(l.type)break}}else p[h].warpBox.hide();p[h].warpBox.attr("data-number",c.getLength(a.result[o[h]]))}else d.msg(a.message||"系统错误");e?q.show():q.hide()}function j(a){var b=a.split("?");return b.length>=2&&b[1]!=""?(b[1]=String(b[1]).replace(/keyword=([^&]*)/i,"").replace(/^&+|&+$/i,""),a=b[0]+"?"+b[1]+"&keyword="+l.val(),a.replace(/^&+|&+$/i,"")):a}var k=a(".search-page-header"),l=k.find("#keyword"),m=a("#show-keyword"),n=null;l.loading=!1,k.on("click","[data-search-page-submit]",function(){l.keyword=l.val(),l.limit=0,g.apply(l,[i,!0])}).on("keyup","#keyword",function(){clearTimeout(n),n=setTimeout(h,500)}),l.type=e,l.cid=f,l.sys="pc",l.size=8;var o=["event","product","rebate","list","article"],p=[],q=a(".no-data"),r=a(".loading"),s=a(".click-loading");l.type&&(l.size=20);for(var t=0;t<o.length;t++)p.push({cacheFn:b.init(a("#"+o[t]+"AjaxLoad-tpl").html()),htmlBox:a("#"+o[t]+"AjaxLoad"),warpBox:a("#"+o[t]+"Warp")});h(),s.click(function(){g.apply(l,[i,!1])}),a("a[href][data-search-singin-url]").click(function(b){a(this).attr("href",j(a(this).attr("href")))})}}})
/*!
 * Copyright 2012, Chris Wanstrath
 * Released under the MIT License
 * https://github.com/defunkt/jquery-pjax
 */

(function(a){function b(b,d,e){var f=this;return this.on("click.pjax",b,function(b){var g=a.extend({},p(d,e));g.container||(g.container=a(this).attr("data-pjax")||f),c(b,g)})}function c(b,c,d){d=p(c,d);var f=b.currentTarget;if(f.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(b.which>1||b.metaKey||b.ctrlKey||b.shiftKey||b.altKey)return;if(location.protocol!==f.protocol||location.hostname!==f.hostname)return;if(f.href.indexOf("#")>-1&&o(f)==o(location))return;if(b.isDefaultPrevented())return;var g={url:f.href,container:a(f).attr("data-pjax"),target:f},h=a.extend({},g,d),i=a.Event("pjax:click");a(f).trigger(i,[h]),i.isDefaultPrevented()||(e(h),b.preventDefault(),a(f).trigger("pjax:clicked",[h]))}function d(b,c,d){d=p(c,d);var f=b.currentTarget;if(f.tagName.toUpperCase()!=="FORM")throw"$.pjax.submit requires a form element";var g={type:f.method.toUpperCase(),url:f.action,container:a(f).attr("data-pjax"),target:f};if(g.type!=="GET"&&window.FormData!==undefined)g.data=new FormData(f),g.processData=!1,g.contentType=!1;else{if(a(f).find(":file").length)return;g.data=a(f).serializeArray()}e(a.extend({},g,d)),b.preventDefault()}function e(b){function c(b,c,e){e||(e={}),e.relatedTarget=d;var f=a.Event(b,e);return h.trigger(f,c),!f.isDefaultPrevented()}b=a.extend(!0,{},a.ajaxSettings,e.defaults,b),a.isFunction(b.url)&&(b.url=b.url());var d=b.target,f=n(b.url).hash,h=b.context=q(b.container);b.data||(b.data={}),a.isArray(b.data)?b.data.push({name:"_pjax",value:h.selector}):b.data._pjax=h.selector;var i;b.beforeSend=function(a,d){d.type!=="GET"&&(d.timeout=0),a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-Container",h.selector);if(!c("pjax:beforeSend",[a,d]))return!1;d.timeout>0&&(i=setTimeout(function(){c("pjax:timeout",[a,b])&&a.abort("timeout")},d.timeout),d.timeout=0);var e=n(d.url);f&&(e.hash=f),b.requestUrl=m(e)},b.complete=function(a,d){i&&clearTimeout(i),c("pjax:complete",[a,d,b]),c("pjax:end",[a,b])},b.error=function(a,d,e){var f=t("",a,b),h=c("pjax:error",[a,d,e,b]);b.type=="GET"&&d!=="abort"&&h&&g(f.url)},b.success=function(d,i,j){var l=e.state,m=typeof a.pjax.defaults.version=="function"?a.pjax.defaults.version():a.pjax.defaults.version,o=j.getResponseHeader("X-PJAX-Version"),p=t(d,j,b),q=n(p.url);f&&(q.hash=f,p.url=q.href);if(m&&o&&m!==o){g(p.url);return}if(!p.contents){g(p.url);return}e.state={id:b.id||k(),url:p.url,title:p.title,container:h.selector,fragment:b.fragment,timeout:b.timeout},(b.push||b.replace)&&window.history.replaceState(e.state,p.title,p.url);var r=a.contains(b.container,document.activeElement);if(r)try{document.activeElement.blur()}catch(s){}p.title&&(document.title=p.title),c("pjax:beforeReplace",[p.contents,b],{state:e.state,previousState:l}),h.html(p.contents);var v=h.find("input[autofocus], textarea[autofocus]").last()[0];v&&document.activeElement!==v&&v.focus(),u(p.scripts);var w=b.scrollTo;if(f){var x=decodeURIComponent(f.slice(1)),y=document.getElementById(x)||document.getElementsByName(x)[0];y&&(w=a(y).offset().top)}typeof w=="number"&&a(window).scrollTop(w),c("pjax:success",[d,i,j,b])},e.state||(e.state={id:k(),url:window.location.href,title:document.title,container:h.selector,fragment:b.fragment,timeout:b.timeout},window.history.replaceState(e.state,document.title)),j(e.xhr),e.options=b;var o=e.xhr=a.ajax(b);return o.readyState>0&&(b.push&&!b.replace&&(v(e.state.id,l(h)),window.history.pushState(null,"",b.requestUrl)),c("pjax:start",[o,b]),c("pjax:send",[o,b])),e.xhr}function f(b,c){var d={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return e(a.extend(d,p(b,c)))}function g(a){window.history.replaceState(null,"",e.state.url),window.location.replace(a)}function h(b){B||j(e.xhr);var c=e.state,d=b.state,f;if(d&&d.container){if(B&&C==d.url)return;if(c){if(c.id===d.id)return;f=c.id<d.id?"forward":"back"}var h=E[d.id]||[],i=a(h[0]||d.container),k=h[1];if(i.length){c&&w(f,c.id,l(i));var m=a.Event("pjax:popstate",{state:d,direction:f});i.trigger(m);var n={id:d.id,url:d.url,container:i,push:!1,fragment:d.fragment,timeout:d.timeout,scrollTo:!1};if(k){i.trigger("pjax:start",[null,n]),e.state=d,d.title&&(document.title=d.title);var o=a.Event("pjax:beforeReplace",{state:d,previousState:c});i.trigger(o,[k,n]),i.html(k),i.trigger("pjax:end",[null,n])}else e(n);i[0].offsetHeight}else g(location.href)}B=!1}function i(b){var c=a.isFunction(b.url)?b.url():b.url,d=b.type?b.type.toUpperCase():"GET",e=a("<form>",{method:d==="GET"?"GET":"POST",action:c,style:"display:none"});d!=="GET"&&d!=="POST"&&e.append(a("<input>",{type:"hidden",name:"_method",value:d.toLowerCase()}));var f=b.data;if(typeof f=="string")a.each(f.split("&"),function(b,c){var d=c.split("=");e.append(a("<input>",{type:"hidden",name:d[0],value:d[1]}))});else if(a.isArray(f))a.each(f,function(b,c){e.append(a("<input>",{type:"hidden",name:c.name,value:c.value}))});else if(typeof f=="object"){var g;for(g in f)e.append(a("<input>",{type:"hidden",name:g,value:f[g]}))}a(document.body).append(e),e.submit()}function j(b){b&&b.readyState<4&&(b.onreadystatechange=a.noop,b.abort())}function k(){return(new Date).getTime()}function l(a){var b=a.clone();return b.find("script").each(function(){this.src||jQuery._data(this,"globalEval",!1)}),[a.selector,b.contents()]}function m(a){return a.search=a.search.replace(/([?&])(_pjax|_)=[^&]*/g,""),a.href.replace(/\?($|#)/,"$1")}function n(a){var b=document.createElement("a");return b.href=a,b}function o(a){return a.href.replace(/#.*/,"")}function p(b,c){return b&&c?c.container=b:a.isPlainObject(b)?c=b:c={container:b},c.container&&(c.container=q(c.container)),c}function q(b){b=a(b);if(!b.length)throw"no pjax container for "+b.selector;if(b.selector!==""&&b.context===document)return b;if(b.attr("id"))return a("#"+b.attr("id"));throw"cant get selector for pjax container!"}function r(a,b){return a.filter(b).add(a.find(b))}function s(b){return a.parseHTML(b,document,!0)}function t(b,c,d){var e={},f=/<html/i.test(b),g=c.getResponseHeader("X-PJAX-URL");e.url=g?m(n(g)):d.requestUrl;if(f)var h=a(s(b.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0])),i=a(s(b.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]));else var h=i=a(s(b));if(i.length===0)return e;e.title=r(h,"title").last().text();if(d.fragment){if(d.fragment==="body")var j=i;else var j=r(i,d.fragment).first();j.length&&(e.contents=d.fragment==="body"?j:j.contents(),e.title||(e.title=j.attr("title")||j.data("title")))}else f||(e.contents=i);return e.contents&&(e.contents=e.contents.not(function(){return a(this).is("title")}),e.contents.find("title").remove(),e.scripts=r(e.contents,"script[src]").remove(),e.contents=e.contents.not(e.scripts)),e.title&&(e.title=a.trim(e.title)),e}function u(b){if(!b)return;var c=a("script[src]");b.each(function(){var b=this.src,d=c.filter(function(){return this.src===b});if(d.length)return;var e=document.createElement("script"),f=a(this).attr("type");f&&(e.type=f),e.src=a(this).attr("src"),document.head.appendChild(e)})}function v(a,b){E[a]=b,G.push(a),x(F,0),x(G,e.defaults.maxCacheLength)}function w(a,b,c){var d,f;E[b]=c,a==="forward"?(d=G,f=F):(d=F,f=G),d.push(b),(b=f.pop())&&delete E[b],x(d,e.defaults.maxCacheLength)}function x(a,b){while(a.length>b)delete E[a.shift()]}function y(){return a("meta").filter(function(){var b=a(this).attr("http-equiv");return b&&b.toUpperCase()==="X-PJAX-VERSION"}).attr("content")}function z(){a.fn.pjax=b,a.pjax=e,a.pjax.enable=a.noop,a.pjax.disable=A,a.pjax.click=c,a.pjax.submit=d,a.pjax.reload=f,a.pjax.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20,version:y},a(window).on("popstate.pjax",h)}function A(){a.fn.pjax=function(){return this},a.pjax=i,a.pjax.enable=z,a.pjax.disable=a.noop,a.pjax.click=a.noop,a.pjax.submit=a.noop,a.pjax.reload=function(){window.location.reload()},a(window).off("popstate.pjax",h)}var B=!0,C=window.location.href,D=window.history.state;D&&D.container&&(e.state=D),"state"in window.history&&(B=!1);var E={},F=[],G=[];a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/),a.support.pjax?z():A()})(jQuery)
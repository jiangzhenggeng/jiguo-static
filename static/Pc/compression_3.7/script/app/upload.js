define(["require","jquery","layer","uploadify","app/tplEngine"],function(a,b,c,d,e){function f(d,e){var d=b(d);if(!d.length)return;var e=b.extend({uploadUrl:"/api/other/AvatarUpdate?key="+Math.random(),width:d.width(),height:d.height()},e);(d.css("position")!="absolute"||d.css("position")!="relative")&&d.css("position","relative");var f=e.uploadUrl,g="file",h=e.width,i=e.height,j=document.createElement("iframe"),k="display:block;width:"+h+"px;height:"+i+"px;overflow:hidden;border:0;margin:0;padding:0;position:absolute;top:0;left:0;filter:alpha(opacity=0);-moz-opacity:0;-khtml-opacity: 0;opacity: 0;cursor:pointer;";c.ready(),b(j).on("load",function(){var e=(+(new Date)).toString(36),l,m,n;m=j.contentDocument||j.contentWindow.document,n=m.body,l=m.createElement("div"),l.innerHTML='<form id="edui_form_'+e+'" target="edui_iframe_'+e+'" method="POST" enctype="multipart/form-data" action="'+f+'" '+'style="'+k+'">'+'<input id="edui_input_'+e+'" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" name="'+g+'" '+'style="'+k+'">'+"</form>"+'<iframe id="edui_iframe_'+e+'" name="edui_iframe_'+e+'" style="display:none;width:0;height:0;border:0;margin:0;padding:0;position:absolute;"></iframe>',l.className="edui-",l.id="_iframeupload",n.style.cssText=k,n.style.width=h+"px",n.style.height=i+"px",n.appendChild(l),n.parentNode&&(n.parentNode.style.width=h+"px",n.parentNode.style.height=h+"px");var o=m.getElementById("edui_form_"+e),p=m.getElementById("edui_input_"+e),q=m.getElementById("edui_iframe_"+e);b(p).on("change",function(){function e(){var a,f,g,h=(q.contentDocument||q.contentWindow.document).body,i=h.innerText||h.textContent||"";try{f=(new Function("return "+i))()}catch(j){c.alert("上传失败,请重新试试");return}if(!("url"in f.result)){c.alert("没有url");return}d.find("input[type=hidden][data-url]").val(f.result.url),d.find("input[type=hidden][data-fileid]").val(f.result.fileid);var l=new Image,m=f.result.url+"?"+Math.random();l.onload=function(){d.find("img[data-upload-img]").show().attr("class","success").attr("src",m)},l.src=m,d.find("#"+k).remove(),o.reset(),b(q).off("load",e)}if(!p.value)return;p.focus();var g=d.find("img[data-upload-img]").first(),h=g.attr("src"),i=a.toUrl("../../style/ext_img/loading-icon.gif"),j="position: absolute;width: 100%;height:100%;left:0;top:0;background: #fff;",k="uploadfixbox123456";j=h==""?j+"background: #fff;":j,g.after('<div style="'+j+'" id="'+k+'"><img class="loading icon-img" src="'+i+'" /></div>'),b(q).on("load",e),o.action=f,o.submit()})}),j.style.cssText=k,d.append(j)}return{init:f,uploadify:function(c,d){b(c).each(function(){var f=document.createElement("input");f.setAttribute("type","file");var g=b(this);if("multiple"in f)var h=e.init(b("#uploadfile-item-safari-tpl").html());else var h=e.init(b("#"+g.attr("data-item-tpl-id")).html());var i=b("#"+g.attr("data-btn-id")),j=function(){return"http://"+window.location.host+"/protected/extensions/uploadify/uploadify.swf";var a,b,d}(),k={timestamp:"1467180227",token:"50638c1f0d92428c0c0c5b0e55abdfbb",type:"zdm"};"multiple"in f?(b("head").append("<style>.webuploader-container>div:not(.webuploader-pick){width:100%!important;height: 100%!important;} input.webuploader-element-invisible{display: block;position: absolute;left: 0;top: 0;width: 100%;height: 100%;-webkit-appearance: none;appearance: none;opacity: 0.01;}</style>"),a(["http://"+window.location.host+"/protected/extensions/ueditor/third-party/webuploader/webuploader.min.js"],function(a){var e="type=zdm&timestamp=1467180227&token=50638c1f0d92428c0c0c5b0e55abdfbb",f=a.create(b.extend({auto:!0,pick:"#"+g.attr("data-btn-id"),formData:k,threads:1,fileVal:"file",duplicate:null,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/jpg,image/jpeg,image/png,image/gif"},swf:"http://"+window.location.host+"/protected/extensions/ueditor/third-party/webuploader/Uploader.swf",server:d.uploadUrl||window.URL.uploadifyUploadUrl+"?"+e},d));f.on("fileQueued",function(a){g.append(h({fileId:a.id}))}),f.on("uploadProgress",function(a,c){b("#"+a.id).find(".uploadify-progress-bar").css("width",c*100+"%")}),f.on("uploadSuccess",function(a,b){d.onUploadSuccess&&d.onUploadSuccess.apply(this,[a,b,g.attr("id")]),f.removeFile(a)}),d.onDelPic&&d.onDelPic.apply(f,[c,f])})):g.uploadify(b.extend({formData:k,fileObjName:"file",itemTemplate:h({}),width:i.width()||150,height:i.height()||150,buttonText:"+",queueID:g.attr("id"),id:g.attr("data-btn-id"),swf:j,uploader:d.uploadUrl||window.URL.uploadifyUploadUrl,onUploadSuccess:function(a,b,c){},removeCompleted:!1,preserve_relative_urls:!0},d))})}}})
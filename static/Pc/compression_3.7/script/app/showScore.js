define(["jquery","global.fun","layer","app/unitTool","app/jqueryRaty","app/tplEngine","app/common"],function(a,b,c,d,e,f,g){function h(b,c,d){this.width=c||112,this.stroke_width=10,this.box=a(b),this.perimeter=Math.ceil(Math.PI*(this.width-this.stroke_width)),this.curr_percent=d||this.perimeter,this.r=(this.width-this.stroke_width)/2,this.cx_cy={cx:this.width/2,cy:this.width/2};var e="id-"+Math.random().toString().replace(".",""),f='                <div class="user-circle-score-wrap" width="'+this.width+'px" height="'+this.width+'px">                    <svg width="'+this.width+'px" height="'+this.width+'px" viewbox="0 0 '+this.width+" "+this.width+'">                        <defs>                            <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">                                <stop offset="0%" stop-color="#FA9161" />                                <stop offset="100%" stop-color="#F7561C" />                            </linearGradient>                        </defs>                        <circle cx="'+this.cx_cy.cx+'px" cy="'+this.cx_cy.cy+'px" r="'+this.r+'px" stroke-width="'+this.stroke_width+'px" stroke="#e5e5e5" fill="none"></circle>                        <circle id="'+e+'" stroke="url(#grad1)" fill="none" stroke-dasharray="'+this.perimeter+"px "+this.perimeter+'px" stroke-dashoffset="'+this.curr_percent+'px" cx="'+this.cx_cy.cx+'px" cy="'+this.cx_cy.cy+'px" r="'+this.r+'px" stroke-width="'+this.stroke_width+'px" transform="translate(86, 86) rotate(-90.000000) translate(-86.000000, -86.000000)"></circle>                    </svg>                    <div class="user-circle-score">                        <div id="g1-'+e+'" style="display:'+(this.curr_percent?"table-cell":"none")+'">                            <div id="score-'+e+'" style="font-size:32px;font-weight:400;color:#000">0.0</div>                            <div id="desc-'+e+'" style="font-size:12px;font-weight:normal;color:#767676"></div>                        </div>                        <div id="g2-'+e+'" style="display:'+(this.curr_percent?"none":"table-cell")+'">您还未评分</div>                    </div>                 </div>';this.box.html(f),this.circle=a("#"+e),this.score=a("#score-"+e),this.desc=a("#desc-"+e),this.g1=a("#g1-"+e),this.g2=a("#g2-"+e)}var i=10;return h.prototype={setScor:function(a,b){function c(){var g=(new Date).getTime(),h=this;f&&clearTimeout(f),g<d+b?(h._setScor(h._getCurrScore(b,g-d,a,this.start_score||0)),f=setTimeout(function(){c.call(h)},e)):(f&&clearTimeout(f),h._setScor(a))}if(a==this.start_score)return;var b=b||800,d=(new Date).getTime(),e=13;if(!(a>0)){this.g1.css("display","none"),this.g2.css("display","table-cell");return}this.g1.css("display","table-cell"),this.g2.css("display","none");var f=null;c.call(this)},_setScor:function(a){this.start_score=a,this.circle.attr({"stroke-dashoffset":Math.ceil((1-a*i/10)*this.perimeter)+"px","stroke-linecap":"round"});var b=(a*i).toFixed(1);this.score.html(b),this.desc.html(this._getScoreDesc(a))},_getCurrScore:function(a,b,c,d){return d+b/a*(c-d)},_getScoreDesc:function(a){var b=a*i,c="";return b<6?c="":b<8?c="用心之作":b<9?c="干货好文":b<=10&&(c="顶级神作"),c}},{createScorCircle:h,getXingDesc:function(a){var b="";return a==1?b="太差了":a==2?b="不太好":a==3?b="一般般":a==4?b="比较好":a==5&&(b="很出色"),b},init:function(){function b(b){if(b=="right")var c=a("#right-report-score-wrap .show-line");else var c=a(".show-line");c.find("[data-animate][data-width]").each(function(){var b=a(this);b.animate({width:b.attr("data-width")*10+"%"})})}var d=f.init(a("#report-score-tpl").html()),e=f.init(a("#right-report-score-tpl").html()),h=this,j=!0;a.get("/api/article/GetBlogScore",{blogid:blogid},function(f){if(f.resultCode!=0){c.msg(f.errorMsg||"获取评分错误");return}var k={play_score:0,profession_score:0,video_score:0,pic_score:0},l=!0;f.result.video==0&&(l=!1,i=9);var m=d({data:f.result,submitScore:k}),n=e({data:f.result}),o=a("#report-score-wrap"),p=a("#right-report-score-wrap");o.html(m),p.html(n),f.result.score_num>0&&p.closest(".right-inner-query").show(),f.result.is_show_score==1&&!(f.result.has_can_score!=1&&f.result.score_num<=0)&&o.closest("#article-score-warp").show(),b("right");if(f.result.has_can_score!=1){var q=a(".userscore");q.length&&a(window).on("scroll.userscore",function(){if(!j)return;var c=q.offset().top;a(window).scrollTop()+a(window).height()+60>c&&(j=!1,b())}).trigger("scroll.userscore")}else{var r=new h.createScorCircle(a(".show-percent-circle").eq(0),172),s=a(".user-score-icon-box"),t=a(".user-submit-score");function u(){var b=0,c=0;s.each(function(){c=parseFloat(a(this).attr("data-score")),b+=c}),r.setScor(b/10)}var v=!1;window.URL.uid||(v=!0,o.on("click",".user-score-icon-box img",function(){g.login()})),s.each(function(b,c){var d=v||a(this).parent().parent().hasClass("no-video");a(c).raty({readOnly:d,number:5,starOff:d?require.toUrl("../style/images/score/xing_3.svg"):require.toUrl("../style/images/score/xing_1.svg"),starOn:d?require.toUrl("../style/images/score/xing_3.svg"):require.toUrl("../style/images/score/xing_2.svg"),score:function(){return a(this).attr("data-number")},mouseover:function(b){if(d)return;a(this).next().html(h.getXingDesc(b)).addClass("orange")},mouseout:function(b){if(d)return;a(this).attr("data-number")>0?a(this).next().html(h.getXingDesc(b)):a(this).next().html("请评分").removeClass("orange")},click:function(b){if(!window.URL.uid){g.login();return}var c=a(this).attr("data-p"),d=c*b;a(this).attr("data-score",d*2),a(this).attr("data-number",b),a(this).next().html(h.getXingDesc(b)).addClass("orange"),(a(".user-score-icon-desc.orange").length>=4&&l||a(".user-score-icon-desc.orange").length>=3&&!l)&&a(".sub-score-btn").addClass("on"),u(),k[a(this).attr("data-submit-key")]=b*2}})}),t.on("click",".sub-score-btn",function(){if(!window.URL.uid){g.login();return}if(a(".user-score-icon-desc.orange").length<4&&l||a(".user-score-icon-desc.orange").length<3&&!l){c.msg("请先评分");return}k.blogid=blogid,a.get("/api/Score/Score",k,function(a){if(a.resultCode!=0){c.msg(a.errorMsg||"获取评分错误");return}var f=d({data:a.result}),g=e({data:a.result});o.html(f),p.closest(".right-inner-query").show(),p.html(g),b(),t.off("click")},"json")})}},"json")}}})
define(["require","global.fun","app/common","app/hotEvent","layer","app/unitTool","app/tplEngine","app/countdown","cookie"],function(a,b,c,d,e,f,g,h,i){function j(){d.init();var a=$("#eventAjaxLoad"),b=$("#change-type"),c=b.find("a");c.click("click",function(){b.find(".on").removeClass("on"),$(this).parent().addClass("on"),a.html(""),$(".loading-more-warp").hide(),$(".click-loading").show(),d.ajaxLoad({url:"/api/event/EventList",boxDom:a,data:{type:type,act:$(this).attr("data-type")}})}).first().trigger("click")}return{listAll:j,show:function(){d.init(),new d.ajaxLoad({url:"/api/event/HotEvent",boxDom:$("#eventHotAjaxLoad"),tplDom:$("#loading-data-list-tpl"),firWarp:"no",data:{id:eventid},size:4})},applyUser:function(){$("#event-apply-user-list").on("click","p.open-btn",function(){var a=$(this).parent().parent();a.find(".show-open-part").hide(),a.find(".show-open-all").show()})},clickApply:function(){e.ready();var a=!1;$("body").on("click","[data-event-apply-input-box]",function(b){b.preventDefault();var d=this;if(typeof popularize=="undefined"&&!window.URL.login){c.login();return}if($(d).attr("data-alert"))return;if(a)return;a=!0,$.post("/api/user/GetUserTel",{},function(b){var c=$(d).closest("[data-metaid]").attr("data-metaid"),f={mobile:b.result};$.post("/api/event/GetStorageList",{meta_id:c},function(b){var c="",h=K.randomId(),i=$("#event-apply-input-tpl").html(),j=$(d).attr("data-remark");f.remark=j,f.data=b.result;var k=e.open({type:1,title:!1,closeBtn:0,shadeClose:!1,area:["510px"],content:'<div id="'+h+'">'+g.init(i,f)+"</div>",success:function(b,c){var d=$(b).find("#apply-event-form-data"),f=!1;a=!1,setTimeout(function(){$(b).find(".apply-input-close").attr("onClick","layer.close('"+k+"')")}),$(b).find(".apply-model-wrap").on("click","li:not(.disabled-btn)",function(){if(!$(this).hasClass("checked")){var a=$(this).find("span").attr("data-storageid"),b=$(this).closest(".apply-model-list").attr("data-no_spec");if(b==1)var c='<input name="spec_remarks" value="'+a+'" type="hidden">';else var c='<input name="storage_id" value="'+a+'" type="hidden">';$(this).addClass("checked").siblings().removeClass("checked"),$(this).append(c).siblings().find("input").remove()}}),$(b).find(".apply-model-btn:not(.disabled-btn)").length<=1&&$(b).find(".apply-model-btn:not(.disabled-btn)").trigger("click"),$(b).find(".btn").click(function(){if(d.find(".apply-model-btn").length>0&&d.find(".apply-model-btn.checked").length==0){e.msg("请选择产品型号");return}if(d.find("[name=comment]").val()==""){e.msg("申请理由不允许为空");return}if(d.find("input[name=tel]").val().length!=11){e.msg("手机号码不允许为空");return}if(d.find("input[name=username]").length&&d.find("input[name=username]").val()==""){e.msg("用户名不允许为空");return}if(!d.find("#agreement").prop("checked")){e.msg("未勾选同意用户协议");return}if(f)return;f=!0;var a=window.applyUrlAPI?window.applyUrlAPI:"/api/event/Apply",b=d.find("input[name=status]"),c=d.serialize();b.is(":checked")||(c+="&status=-1"),$.post(a,c,function(a){f=!1,a.resultCode==0?e.msg("申请成功",{type:1},function(){e.closeAll(),window.location.reload()}):e.msg(a.errorMsg)},"json")})},end:function(){}})},"json")},"json")})},requestCardData:function(){var a=g.init($("#event-buy-right-card-tpl").html());$.get("/api/event/EventSide",{id:eventid},function(b){if(f.getLength(b.result)){var c=a({data:b.result});$(".event-buy-right-card").html(c);var d=$("[data-countdown]");d.length&&d.each(function(){if($(this).attr("data-unq")){if($(this).attr("data-countdown")>0){var a=$("#"+$(this).attr("data-unq"));a.addClass("gray").attr("_href",a.attr("href")).attr("href","javascript:;").attr("target","_self")}h.run({intDiff:$(this).attr("data-countdown"),dom:$(this),callback:function(){var a=$("#"+$(this).attr("data-unq"));a.removeClass("gray").addClass("red").attr("href",a.attr("_href")).attr("target","_blank").html("立即试用")}})}else h.run({intDiff:$(this).attr("data-countdown"),dom:$(this),isglobal:!0,callback:function(){window.location.reload()}})})}$(".event-buy-right-card").on("mouseenter","[data-show-intro]",function(){$(this).find(".intro.alert-show").show()}).on("mouseleave","[data-show-intro]",function(){$(this).find(".intro.alert-show").hide()}).find("[data-show-intro]").click(function(){e.ready(function(){e.msg("请在手机上扫码申请")})})},"json")},requestBannerData:function(){$.get("/api/event/IndexEventBanner",{id:eventid},function(a){if(f.getLength(a.result)){var b=$(".event-banner-get-data");a.result.residueTime?b.find(".event-banner-get-time").html("申请截止: "+a.result.residueTime):b.find(".event-banner-get-time").html("&nbsp;"),b.find(".btn").attr("class","btn "+a.result.status).html(a.result.buying_status),"isapply"in a.result&&a.result.isapply&&b.find(".btn").attr(a.result.isapply,""),"url"in a.result&&a.result.url&&b.find(".btn").attr("href",a.result.url),b.fadeIn(500)}},"json")},getEventUserList:function(){var a=$(".autor-list-wrap");$.get("/api/event/Roster",{id:eventid},function(b){if(b.result.num>0){var c=g.init($("#use-apply-list-tpl").html(),{data:b.result.meta_list});$("#use-apply-list").html(c),setTimeout(function(){a.height()>230&&($("#use-apply-list").addClass("hidden-list"),$(".look-all-wrap").show())}),$(".event-user-list-warp").fadeIn(250)}},"json"),$(".look-more").click(function(){$(this).hide(),$(".pack-up").show(),a.removeClass("hidden-list")}),$(".pack-up").click(function(){$(this).hide(),$(".look-more").show(),a.addClass("hidden-list")})},getEventBlogList:function(a){new d.ajaxLoad({url:"/api/event/EventLinkBlog",boxDom:$("#blogAjaxLoad"),tplDom:"#event-load-blog-tpl",firWarp:".event-blog-list",limit:a,triggerType:"click",dataChange:function(a,b){return a.result=a.result.blog,a},size:3,data:{id:eventid}})},getEventIntro:function(){$("body").on("click","[data-metaintro]",function(){var a=$(this).closest("[data-metaid]").attr("data-metaid"),b=e.open({type:1,title:!1,closeBtn:0,scrollbar:!1,shadeClose:!1,area:["510px","550px"],content:'                    <div class="event-apply-input-box">                        <div class="apply-input-header mb10">                            <h3>试用细则</h3>                            <div class="apply-input-close icon" data-closelayer></div>                        </div>                        <div class="event-intro-wrap ft14 pdt5"></div>                     </div>',success:function(c,d){$.post("/api/event/GetMetaDetail",{meta_id:a},function(a){a.success?$(c).find(".event-intro-wrap").html(a.result):e.msg(a.errorMsg||"操作失败")},"json"),setTimeout(function(){$(c).find("[data-closelayer]").attr("onClick","layer.close('"+b+"')")})}})})},alertTips:function(){$("body").on("click","[data-alert]",function(){if(!window.URL.login)return;var a=this;$.post("/api/user/islogin",{},function(b){b.success=="true"&&(b.result.login==1?e.msg($(a).attr("data-alert")):c.login())},"json")})}}})
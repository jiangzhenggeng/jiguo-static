define(["jquery","app/tplEngine","app/unitTool","layer"],function(a,b,c,d){return{searchAll:function(e,f,g){function h(b,c){var d=this,e=String(d.keyword).replace(/^\s+|\s+$/i,"");if(d.loading)return;d.loading=!0;var f=a("title").html(),g=k(window.location.href);history.pushState({title:f},f,g),s.show(),r.hide(),t.hide(),a.get("/api/search/index",{keyword:e,type:d.type,cid:d.cid,limit:d.limit,sys:d.sys,size:d.size},function(a){d.loading=!1,s.hide(),d.limit=a.limit,b.apply(d,[a,c])},"json")}function i(a){m.limit=a||0,m.keyword=m.val(),h.apply(m,[j,!0,a]),n.html(m.keyword)}function j(a,b,e){var f=!0,g=0,h=this;if(a.resultCode==0)for(var i=0;i<p.length;i++){g=c.getLength(a.result[p[i]]);if(g>0){q[i].warpBox.show();if(q[i].htmlBox.length){f=!1,b&&e<=0?q[i].htmlBox.html(q[i].cacheFn({data:a.result[p[i]]})):q[i].htmlBox.append(q[i].cacheFn({data:a.result[p[i]]})),g<h.size?(t.hide(),m.type?(f=!0,r.show()):r.hide()):m.type?(t.show(),r.hide()):(r.hide(),t.hide());if(m.type)break}}else e<=0&&q[i].warpBox.hide();q[i].warpBox.attr("data-number",c.getLength(a.result[p[i]]))}else d.msg(a.message||"系统错误");f?r.show():r.hide()}function k(a){var b=a.split("?");return b.length>=2&&b[1]!=""?(b[1]=String(b[1]).replace(/keyword=([^&]*)/i,"").replace(/^&+|&+$/i,""),a=b[0]+"?"+b[1]+"&keyword="+m.val(),a.replace(/^&+|&+$/i,"")):a}var l=a(".search-page-header"),m=l.find("#keyword"),n=a("#show-keyword"),o=null;m.loading=!1,l.on("click","[data-search-page-submit]",function(){m.keyword=m.val(),m.limit=0,h.apply(m,[j,!0])}).on("keyup","#keyword",function(){clearTimeout(o),o=setTimeout(i,500)}),m.type=e,m.cid=f,m.sys="pc",m.limit=g||"0",m.size=8;var p=["event","product","rebate","list","article"],q=[],r=a(".no-data"),s=a(".loading"),t=a(".click-loading");m.type&&(m.size=20);for(var u=0;u<p.length;u++)q.push({cacheFn:b.init(a("#"+p[u]+"AjaxLoad-tpl").html()),htmlBox:a("#"+p[u]+"AjaxLoad"),warpBox:a("#"+p[u]+"Warp")});i(g),t.click(function(){h.apply(m,[j,!1])}),a("a[href][data-search-singin-url]").click(function(b){a(this).attr("href",k(a(this).attr("href")))})}}})
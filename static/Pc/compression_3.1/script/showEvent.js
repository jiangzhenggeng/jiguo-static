define(["require","global.fun","app/common","app/hotEvent","layer","app/unitTool","app/tplEngine","app/countdown","cookie"],function(a,b,c,d,e,f,g,h,i){function j(){d.init();var a=$("#eventAjaxLoad"),b=$("#change-type"),c=b.find("a");c.click("click",function(){b.find(".on").removeClass("on"),$(this).parent().addClass("on"),a.html(""),$(".loading-more-warp").hide(),$(".click-loading").show(),d.ajaxLoad({url:"/api/event/EventList",boxDom:a,data:{type:type,act:$(this).attr("data-type")}})}).first().trigger("click")}return{listAll:j,show:function(){d.init(),new d.ajaxLoad({url:"/api/event/HotEvent",boxDom:$("#eventHotAjaxLoad"),tplDom:$("#loading-data-list-tpl"),firWarp:"no",data:{id:eventid},size:4})},applyUser:function(){new d.ajaxLoad({url:"/api/comment/GetEventApply",boxDom:$("#event-apply-user-list"),tplDom:$("#event-apply-user-list-tpl"),firWarp:$("#event-apply-user-list-fire"),triggerType:"click",size:10,data:{id:eventid}}),$("#event-apply-user-list").on("click","p.open-btn",function(){var a=$(this).parent().parent();a.find(".show-open-part").hide(),a.find(".show-open-all").show()})},clickApply:function(){e.ready(),$("body").on("click","[data-event-apply-input-box]",function(a){a.preventDefault();if(typeof popularize=="undefined"&&!window.URL.login){c.login();return}if($(this).attr("data-alert"))return;var b=K.randomId(),d=$("#event-apply-input-tpl").html(),f=$(this).closest("[data-metaid]").attr("data-metaid"),h=$(this).attr("data-remark"),i={remark:h},j=e.open({type:1,title:!1,closeBtn:0,shadeClose:!1,area:["510px"],content:'<div id="'+b+'">'+g.init(d,i)+"</div>",success:function(a,b){setTimeout(function(){$(a).find(".apply-input-close").attr("onClick","layer.close('"+j+"')")});var c=$(a).find("#apply-event-form-data");$.post("/api/event/GetStorageList",{meta_id:f},function(b){var d=b.result,e="";if(d.no_spec==1)e+='<input name="storage_id" value="'+d.first_storage.id+'" type="hidden">',c.find(".apply-model-wrap").hide();else for(var f in d.storage_list)d.storage_list[f].all_storage>0?e+='<li class="apply-model-btn"><span data-storageid="'+d.storage_list[f].id+'">'+d.storage_list[f].spec_name+"</span></li>":e+='<li class="apply-model-btn disabled-btn"><span data-storageid="'+d.storage_list[f].id+'">'+d.storage_list[f].spec_name+"</span></li>";c.find(".apply-model-list").html(e),$(a).find(".apply-model-btn:not(.disabled-btn)").length<=1&&$(a).find(".apply-model-btn:not(.disabled-btn)").trigger("click")},"json"),$(a).find(".apply-model-wrap").on("click","li:not(.disabled-btn)",function(){if(!$(this).hasClass("checked")){var a=$(this).find("span").attr("data-storageid"),b='<input name="storage_id" value="'+a+'" type="hidden">';$(this).addClass("checked").siblings().removeClass("checked"),$(this).append(b).siblings().find("input").remove()}}),$(a).find(".btn").click(function(){var a={path:"/",expires:36e6};if(c.find(".apply-model-btn").length>0&&c.find(".apply-model-btn.checked").length==0){e.msg("请选择产品型号");return}if(c.find("input[name=tel]").val().length!=11){e.msg("手机号码不允许为空");return}if(c.find("input[name=username]").length&&c.find("input[name=username]").val().length==""){e.msg("用户名不允许为空");return}if(!c.find("#agreement").prop("checked")){e.msg("未勾选同意用户协议");return}var b=window.applyUrlAPI?window.applyUrlAPI:"/api/event/Apply",d=c.find("input[name=status]"),f=c.serialize();d.is(":checked")||(f+="&status=-1"),$.post(b,f,function(a){a.resultCode==0?e.msg("申请成功",{type:1},function(){e.closeAll(),window.location.reload()}):e.msg(a.errorMsg)},"json")})},end:function(){}})})},requestCardData:function(){var a=g.init($("#event-buy-right-card-tpl").html());$.get("/api/event/EventSide",{id:eventid},function(b){if(f.getLength(b.result)){var c=a({data:b.result});$(".event-buy-right-card").html(c);var d=$("[data-countdown]");d.length&&d.each(function(){if($(this).attr("data-unq")){if($(this).attr("data-countdown")>0){var a=$("#"+$(this).attr("data-unq"));a.addClass("gray").attr("_href",a.attr("href")).attr("href","javascript:;").attr("target","_self")}h.run({intDiff:$(this).attr("data-countdown"),dom:$(this),callback:function(){var a=$("#"+$(this).attr("data-unq"));a.removeClass("gray").addClass("red").attr("href",a.attr("_href")).attr("target","_blank").html("立即试用")}})}else h.run({intDiff:$(this).attr("data-countdown"),dom:$(this),isglobal:!0,callback:function(){window.location.reload()}})})}$(".event-buy-right-card").on("mouseenter","[data-show-intro]",function(){$(this).find(".intro.alert-show").show()}).on("mouseleave","[data-show-intro]",function(){$(this).find(".intro.alert-show").hide()}).find("[data-show-intro]").click(function(){e.ready(function(){e.msg("请在手机上扫码申请")})})},"json")},requestBannerData:function(){$.get("/api/event/IndexEventBanner",{id:eventid},function(a){if(f.getLength(a.result)){var b=$(".event-banner-get-data");a.result.residueTime?b.find(".event-banner-get-time").html("申请截止: "+a.result.residueTime):b.find(".event-banner-get-time").html("&nbsp;"),b.find(".btn").attr("class","btn "+a.result.status).html(a.result.buying_status),"isapply"in a.result&&a.result.isapply&&b.find(".btn").attr(a.result.isapply,""),"url"in a.result&&a.result.url&&b.find(".btn").attr("href",a.result.url),b.fadeIn(500)}},"json")},getEventUserList:function(){var a=$(".autor-list-wrap");$.get("/api/event/Roster",{id:eventid},function(b){if(b.result.num>0){var c=g.init($("#use-apply-list-tpl").html(),{data:b.result.meta_list});$("#use-apply-list").html(c),setTimeout(function(){a.height()>230&&($("#use-apply-list").addClass("hidden-list"),$(".look-all-wrap").show())}),$(".event-user-list-warp").fadeIn(250)}},"json"),$(".look-more").click(function(){$(this).hide(),$(".pack-up").show(),a.removeClass("hidden-list")}),$(".pack-up").click(function(){$(this).hide(),$(".look-more").show(),a.addClass("hidden-list")})},getEventBlogList:function(){new d.ajaxLoad({url:"/api/event/EventLinkBlog",boxDom:$("#blogAjaxLoad"),tplDom:"#event-load-blog-tpl",firWarp:".event-blog-list",triggerType:"click",dataChange:function(a,b){return a.result.meta.count>0&&$(b.boxDom).parent().parent().show(),$("#event-blog-list-tips").html("共有"+a.result.meta.count+"篇关于"+a.result.meta.name+"的报告"),a.result=a.result.blog,a},size:3,data:{id:eventid}})},getEventIntro:function(){$("body").on("click","[data-metaintro]",function(){var a=$(this).closest("[data-metaid]").attr("data-metaid"),b=e.open({type:1,title:!1,closeBtn:0,scrollbar:!1,shadeClose:!1,area:["510px","550px"],content:'                    <div class="event-apply-input-box">                        <div class="apply-input-header mb10">                            <h3>试用细则</h3>                            <div class="apply-input-close icon" data-closelayer></div>                        </div>                        <div class="event-intro-wrap ft14 pdt5"></div>                     </div>',success:function(c,d){$.post("/api/event/GetMetaDetail",{meta_id:a},function(a){a.success?$(c).find(".event-intro-wrap").html(a.result):e.msg(a.errorMsg||"操作失败")},"json"),setTimeout(function(){$(c).find("[data-closelayer]").attr("onClick","layer.close('"+b+"')")})}})})},alertTips:function(){$("body").on("click","[data-alert]",function(){if(!window.URL.login)return;e.msg($(this).attr("data-alert"))})}}})
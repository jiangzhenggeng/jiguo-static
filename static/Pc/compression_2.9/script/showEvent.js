define(["require","global.fun","app/common","app/hotEvent","layer","app/unitTool","app/tplEngine","app/countdown","cookie"],function(require,global,common,hotEvent,layer,unitTool,tplEngine,countdown,_){function _init(){hotEvent.init();var a=$("#eventAjaxLoad"),b=$("#change-type"),c=b.find("a");c.click("click",function(){b.find(".on").removeClass("on"),$(this).parent().addClass("on"),a.html(""),$(".loading-more-warp").hide(),$(".click-loading").show(),hotEvent.ajaxLoad({url:"/api/event/EventList",boxDom:a,data:{act:$(this).attr("data-type"),type:type}})}).first().trigger("click")}return{listAll:_init,show:function(){hotEvent.init(),new hotEvent.ajaxLoad({url:"/api/event/HotEvent",boxDom:$("#eventHotAjaxLoad"),tplDom:$("#loading-data-list-tpl"),firWarp:"no",data:{id:eventid},size:4})},applyUser:function(){new hotEvent.ajaxLoad({url:"/api/event/GetComment",boxDom:$("#event-apply-user-list"),tplDom:$("#event-apply-user-list-tpl"),firWarp:$("#event-apply-user-list-fire"),triggerType:"click",size:10,data:{id:eventid}}),$("#event-apply-user-list").on("click","p.open-btn",function(){var a=$(this).parent().parent();a.find(".show-open-part").hide(),a.find(".show-open-all").show()})},clickApply:function(){layer.ready(),$("body").on("click","[data-event-apply-input-box]",function(e){e.preventDefault();if(typeof popularize=="undefined"&&!window.URL.login){common.login();return}var id=K.randomId(),html=$("#event-apply-input-tpl").html(),lId=layer.open({type:1,title:!1,closeBtn:0,shadeClose:!1,area:["490px"],content:'<div id="'+id+'">'+tplEngine.init(html,{_apply_comment:$.cookie("_apply_comment")})+"</div>",success:function(layero,index){setTimeout(function(){$(layero).find(".apply-input-close").attr("onClick","layer.close('"+lId+"')")});var Obj=$(layero).find("#apply-event-form-data");$(layero).find(".btn").click(function(){var cookie_option={path:"/",expires:36e6};$.cookie("_apply_comment",Obj.find("textarea[name=comment]").val(),cookie_option);if(Obj.find("input[name=tel]").val().length!=11){layer.msg("手机号码不允许为空");return}if(Obj.find("input[name=username]").length&&Obj.find("input[name=username]").val().length==""){layer.msg("用户名不允许为空");return}var applyUrlAPI=window.applyUrlAPI?window.applyUrlAPI:"/api/event/Apply",formData=Obj.serialize();$.post(applyUrlAPI,formData,function(replayData){typeof popularize!="undefined"?replayData==1?layer.msg("申请成功",{type:1},function(){layer.closeAll(),window.location.reload()}):layer.msg("申请失败"):(eval("var replayData ="+replayData),replayData.resultCode==0?layer.msg("申请成功",{type:1},function(){layer.closeAll(),window.location.reload()}):layer.msg(replayData.errorMsg))})})},end:function(){}})})},requestCardData:function(){var a=tplEngine.init($("#event-buy-right-card-tpl").html());$.get("/api/event/EventSide",{id:eventid},function(b){if(unitTool.getLength(b.result)){var c=a({data:b.result});$(".event-buy-right-card").html(c);var d=$("[data-countdown]");d.length&&d.each(function(){if($(this).attr("data-unq")!=""){if($(this).attr("data-countdown")>0){var a=$("#"+$(this).attr("data-unq"));a.addClass("gray").attr("_href",a.attr("href")).attr("href","javascript:;")}countdown.run({intDiff:$(this).attr("data-countdown"),dom:$(this),callback:function(){var a=$("#"+$(this).attr("data-unq"));a.removeClass("gray").addClass("red").attr("href",a.attr("_href"))}})}else countdown.run({intDiff:$(this).attr("data-countdown"),dom:$(this)})})}$(".event-buy-right-card").on("mouseenter","[data-show-intro]",function(){$(this).find(".intro.alert-show").show()}).on("mouseleave","[data-show-intro]",function(){$(this).find(".intro.alert-show").hide()}).find("[data-show-intro]").click(function(){layer.ready(function(){layer.msg("请在手机上扫码申请")})})},"json")},requestBannerData:function(){$.get("/api/event/IndexEventBanner",{id:eventid},function(a){if(unitTool.getLength(a.result)){var b=$(".event-banner-get-data");a.result.residueTime?b.find(".event-banner-get-time").html("申请截止: "+a.result.residueTime):b.find(".event-banner-get-time").html("&nbsp;"),b.find(".btn").attr("class","btn "+a.result.status).html(a.result.buying_status),"isapply"in a.result&&a.result.isapply&&b.find(".btn").attr(a.result.isapply,""),"url"in a.result&&a.result.url&&b.find(".btn").attr("href",a.result.url),b.fadeIn(500)}},"json")},getEventUserList:function(){$.get("/api/event/Roster",{id:eventid},function(a){if(unitTool.getLength(a.result)){var b=tplEngine.init($("#use-apply-list-tpl").html(),{data:a.result});$("#use-apply-list").html(b),$(".event-user-list-warp").fadeIn(250)}},"json")},getEventBlogList:function(){new hotEvent.ajaxLoad({url:"/api/event/EventLinkBlog",boxDom:$("#blogAjaxLoad"),tplDom:"#event-load-blog-tpl",firWarp:".event-blog-list",triggerType:"click",dataChange:function(a,b){return a.result.meta.count>0&&$(b.boxDom).parent().parent().show(),$("#event-blog-list-tips").html("共有"+a.result.meta.count+"篇关于"+a.result.meta.name+"的报告"),a.result=a.result.blog,a},size:3,data:{id:eventid}})}}})
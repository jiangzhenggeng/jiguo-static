define(["jquery","app/common","app/unitTool","app/tplEngine","layer"],function(a,b,c,d,e){function f(){for(;window.viewArray.length;)window.viewArray.pop().slideUp("160",function(){a(this).prev().find(".s-1").show(),a(this).prev().find(".s-2").hide()})}function g(b){var c=b.find("> .comment-list-box"),d=a(window).height(),e=c.find(".comment-sub-shouqi"),f=100,g=c.offset().top,h=a(window).scrollTop(),i=h+d-f-g-62;i>c.height()-f&&(i=c.height()-f),i<=20&&(i=20),e.css({top:i})}return window.viewArray=[],{init:function(){function b(){this.limit=0,this.id=blogid,this.type=2,this.size=10,this.len=0,this.is_loading=!1,this.commentWarp=a("#comment-show-list"),this.loadmore=a(".comment-load-more"),this.loading=a(".comment-load-ing"),this.nodata=a(".comment-load-no-data"),this.commentWarp.on("blur","textarea[data-comment-replay-sub]",function(){var b=this;setTimeout(function(){a(b).parent().parent().parent().hide()},180)})}var e=d.init(a("#comment-show-list-tpl").html()),f=d.init(a("#comment-show-list-sub-tpl").html());b.prototype={getData:function(){var b=this;if(b.is_loading)return;b.is_loading=!0,b.loadmore.hide(),b.loading.show(),a.get("/api/comment/GetComment",{limit:b.limit,id:b.id,type:b.type,size:b.size},function(a){b.loading.hide(),b.len=c.getLength(a.result);if(b.len){for(var d in a.result)a.result[d].subString="","child_comment"in a.result[d]&&c.getLength(a.result[d].child_comment)>0&&(a.result[d].subString=f({data:a.result[d].child_comment}));b.commentWarp.append(e({data:a.result})),b.limit=a.limit,b.is_loading=!1,b.len<b.size?(b.is_loading=!0,b.nodata.show()):b.loadmore.show()}else b.is_loading=!0,b.nodata.show()},"json")}};var g=new b;a(".comment-load-more").bind("click",function(){g.getData()}),g.getData()},sendComment:function(){var c=d.init(a("#comment-show-list-tpl").html()),f=d.init(a("#comment-show-list-sub-tpl").html()),h=a("#comment-send-top-warp"),i=a("#comment-show-list");a("body").on("focus","textarea",function(){if(!window.URL.login){a(this).blur(),b.login();return}});var j=h.find("[data-comment-send]");h.on("keyup","[data-comment-textarea]",function(){a(this).val().toString().trim()!=""?j.removeClass("gray"):j.addClass("gray")}).on("focus","[data-comment-textarea]",function(){j._TopTextBoxHeight_=a(this).outerHeight(),a(this).height(60)}).on("blur","[data-comment-textarea]",function(){setTimeout(function(){a(this).height(j._TopTextBoxHeight_)},1e3)}),e.ready();var k=!1;h.on("click","[data-comment-send]",function(){var b=h.find("[data-comment-textarea]"),d=b.val().toString().trim();if(d==""){e.msg("请填写评论内容",{time:window.URL.diagloaTime});return}if(k){k=!0;return}a.get("/api/comment/PostComment",{id:blogid,type:2,content:d,parent_id:0,commentid:0},function(f){k=!1;if(f.resultCode==0){var g=c({data:[{uid:f.result.uid,username:f.result.username,avatar:f.result.avatar,content:d,add_time:"刚刚",praise:0,reply:0,cid:f.result.cid,style:"display:none;"}]}),h=i.find("li:first");h.length?h.before(g):i.append(g),b.val(""),i.find("li:first").slideDown(150);var j=a("#comment-num-all-num");j.html(parseInt(j.html())+1),i.find("li:first").find(".comment-sub-list-warp").hide()}else e.msg(f.errorMsg||"系统错误",{time:window.URL.diagloaTime})},"json")});var l=!1;i.on("click","[data-comment-sub-send]",function(){var b=a(this),c=b.parents("[data-top-li]"),d=c.attr("id"),g=a("#sub-ul"+d),h=b.parent().parent(),i=h.find("[data-comment-sub-textarea]"),j=i.val().toString().trim();if(j==""){e.msg("请填写评论内容",{time:window.URL.diagloaTime});return}if(l){l=!0;return}a.get("/api/comment/PostComment",{id:blogid,type:2,content:j,parent_id:a(this).attr("data-parent_id"),commentid:a(this).attr("data-cid")},function(a){l=!1;if(a.resultCode==0){var b=f({data:[{uid:a.result.uid,username:a.result.username,replyuser:i.attr("data-re-name"),content:j,avatar:a.result.avatar,add_time:"刚刚",praise:0,reply:0,cid:a.result.cid}]}),c=g.find("li:first");c.length?(c.before(b),g.find("li:first").hide().slideDown(150)):(g.append(b),g.parent().slideDown(150)),i.val("")}else e.msg(a.errorMsg||"系统错误",{time:window.URL.diagloaTime})},"json")}),i.on("click","[data-replay-top]",function(){var c=a(this),d=a(this).parents("[data-top-li]"),e=d.attr("id"),f=a("#sub"+e),h=f.find(".comment-input-box-outer-warp");f.find("#sub-ul"+e).find("li").length<=0&&f.find(">.comment-list-box").hide();if(!c.data("data-first")){c.data("data-first",!0);if(!window.URL.login){b.login();return}h.show(),h.find("textarea").focus(),a(window).bind("scroll.a",function(){g(f)}),d.find(".s-1").hide(),d.find(".s-2").show(),f.slideDown(160,function(){a("html,body").css({scrollTop:h.offset().top-200})});return}f.css("display")=="none"?(f.slideDown(160,function(){h.show(),h.find("textarea").focus(),a("html,body").css({scrollTop:h.offset().top-200})}),d.find(".s-1").hide(),d.find(".s-2").show(),f.off("keyup click"),a(window).bind("scroll",function(){g(f)})):(f.slideUp(160,function(){d.find(".s-1").show(),d.find(".s-2").hide()}),f.off("keyup click"),a(window).unbind("scroll.a"))}),i.on("keyup","[data-comment-sub-textarea]",function(){var b=a(this).parent().parent().next().find(".btn");a(this).val().toString().trim()!=""?b.removeClass("gray"):b.addClass("gray")}),i.on("click","[data-sub-load-more]",function(){var b=a(this);if(b.data("loading")==1)return;b.data("loading",!0);var c=b.parents("[data-top-li]"),d=c.attr("id"),e=a("#sub"+d);b.hide();var h=b.nextAll(".comment-load-ing");h.show(),a.get("/api/comment/GetChildcomments",{id:c.attr("data-cid"),size:200},function(c){h.hide(),b.hide(),b.prev().html(f({data:c.result})),b.prev().prev().show(),a(window).bind("scroll.a",function(){g(e)})},"json")}),i.on("click","[data-sub-zan]",function(){if(!window.URL.login){b.login();return}var c=a(this);if(c.hasClass("red"))return;a.get("/api/praise/praise",{id_value:a(this).attr("data-cid"),status:"",type:3},function(a){if(a.resultCode==-100){b.login();return}if(a.resultCode==0){var d=c.find("[data-sub-zan-box]");d.html(parseInt(d.html())+1),c.addClass("red like")}},"json")}),i.on("click","[data-sub-replay]",function(){if(!window.URL.login){b.login();return}var c=a(this).parent().parent().next(".comment-input-box");c.show(),c.find("textarea").focus()}),i.on("click","[data-sub-cansel]",function(){a(this).parent().parent().hide()}),i.on("click","[data-cansel]",function(){a(this).parent().parent().hide()})}}})
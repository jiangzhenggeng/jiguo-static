define(["jquery","app/unitTool","app/tplEngine","app/md5","app/localDataCache"],function(a,b,c,d,e){function f(b){var b=a.extend({size:10,url:"/api/article/GetArticleList",boxDom:"#ajax-loading-home-box",fireDom:".loading-more",tplDom:"#ajax-loading-home-box-tpl",sendData:{},firstNoData:!1,autoLoading:!0,topic:!1,data:!1,touchBox:!1,callBack:function(){}},b);this.options=b,this.__box__=b.boxDom,this.options.boxDom=a(this.options.boxDom),this.options.fireDom=a(this.options.fireDom);var d=this.options.fireDom.parent();this.options.noData=d.find(".no-data"),this.options.firstNoDataDom=d.find(".first-no-data"),this.options.notTopicDom=d.find("[data-notTopic]"),this.options.topicDom=d.find("[data-topic]"),this.options.tplDom=a(this.options.tplDom),this.loading=!0;var e=a(".loading");this.tplFunCache=c.init(this.options.tplDom.html()),this.options.sendData.limit=0,this.options.sendData.size=b.size,this.options.sendData.sys="mb",this.options.first=!0}function g(b){var c=e.getPageCacheData(i+"time");+(new Date)-c>18e4&&[i,i+"limit",i+"box",i+"point"].forEach(function(a,b){e.delPageCacheData(a)});var d=new f(b),g=e.getPageCacheData(i),h=e.getPageCacheData(i+"limit"),j=e.getPageCacheData(i+"box"),k=e.getPageCacheData(i+"point");return!window.__no_session_cache__&&j&&g&&String(g||"").length>100?(a(j).html(g),d.options.sendData.limit=h,k>0&&setTimeout(function(){a("html,body").animate({scrollTop:k},160)},20)):d.run(),d.options.autoLoading&&(d.options.touchBox?a("[data-touchBox]").scroll(function(){var b=a("[data-touchBox]").scrollTop()+a("[data-touchBox]").height()+200;d.loading&&d.options.fireDom.length&&b>d.options.fireDom.offset().top&&d.run()}):a(window).scroll(function(){var b=a(window).scrollTop()+a(window).height()+200;d.loading&&d.options.fireDom.length&&b>d.options.fireDom.offset().top&&d.run()})),a("body").click(function(){e.setPageCacheData(i+"point",a(window).scrollTop())}),d}var h=a(window).height(),i=d.init(window.location.href);return f.prototype.run=function(){var c=this;if(!c.loading)return!0;c.loading=!1,c.options.fireDom.show(),c.options.noData.hide(),c.options.firstNoDataDom.removeClass("flex"),c.options.notTopicDom.show(),c.options.topicDom.hide(),a.get(c.options.url,c.options.sendData,function(d){var f;c.options.data?f=b.getLength(d.result.data):f=b.getLength(d.result);if(f){var g=c.tplFunCache({data:d.result});c.options.boxDom.append(g),c.options.sendData.limit=b.has(d,"limit")?d.limit:0,f<c.options.sendData.size?(c.loading=!1,c.options.noData.show(),c.options.fireDom.hide()):(c.loading=!0,c.options.fireDom.length&&h>c.options.fireDom.offset().top&&c.run()),g=e.getPageCacheData(i)+g,e.setPageCacheData(i,g),e.setPageCacheData(i+"limit",c.options.sendData.limit),e.setPageCacheData(i+"box",c.__box__),e.setPageCacheData(i+"time",+(new Date))}else{if(c.options.first&&c.options.firstNoData){var j=a(window).height()-c.options.firstNoDataDom.parent().parent().offset().top;c.options.firstNoDataDom.addClass("flex").removeClass("pdt15").css("height",j),c.options.topic?(c.options.topicDom.show(),c.options.notTopicDom.hide()):(c.options.topicDom.hide(),c.options.notTopicDom.show())}else c.options.noData.show(),c.options.firstNoDataDom.removeClass("flex");c.load=!1,c.options.fireDom.hide()}c.options.callBack(c,f),c.options.first=!1},"json")},a(function(){a(".logo>h1>a[href]").click(function(){sessionStorage.clear()})}),{init:g}})
define(["jquery","layer","app/login","app/tplEngine","app/unitTool"],function(a,b,c,d,e){function f(){var a="";for(var b=0;b<window.commentSubView.length;b++)a=window.commentSubView.pop(),a.hide(),a=a.prev().find("[data-show-comment-replay]"),a.addClass("icon").find(".s-2").hide(),a.find(".s-1").show(),a.data("data-limit","")}function g(){var a="";for(var b=0;b<window.commentSubView2.length;b++)a=window.commentSubView2.pop(),a.hide(),a=a.prev().find("[data-show-comment-replay]"),a.addClass("icon").find(".s-2").hide(),a.find(".s-1").show()}function h(c,f,g){var h=c.attr("data-li"),i=a("#sub-ul"+h),j=d.init(a("#ajax-loading-sub-tpl").html()),k=i.next(),m=g||l;k.find(".comment-click-loading").hide(),k.find(".comment-is-loading").show(),a.get("/api/comment/GetChildcomments",{limit:c.data("data-limit"),id:c.attr("data-cid"),size:m},function(a){if(a.resultCode==0){k.find(".comment-is-loading").hide();var d=e.getLength(a.result);window.randomid=h;if(d<=0){k.hide();return}k.show(),f?(i.html(j({data:a.result})).parent().show(),d>=m?k.find(".comment-click-loading").show():k.hide()):(i.append(j({data:a.result})).parent().show(),d>=m?k.find(".comment-click-loading").show():k.hide()),c.data("data-limit",a.limit)}else b.open({content:a.errorMsg||"系统错误",time:1})},"json")}if(typeof blogid=="undefined"||window.location.href.indexOf("article/article")==-1)return{};var i=a("#comment-top-content"),j=blogid,k=null,l=5;return window.commentSubView=[],window.commentSubView2=[],a("body").on("focus","textarea",function(){if(!window.URL.login){c.login();return}}),a("#ajax-loading-home-box").on("click",".comment-click-loading",function(){var b=a("#fire-loading"+a(this).attr("data-li"));h(b)}),a("body").on("click","[data-show-comment-replay]",function(){if(!window.URL.uid){c.login();return}var e=navigator.userAgent;!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)||a("body").css({height:0});var f=a(this).attr("data-parent_id")||0,g=a(this).attr("data-cid")||0,h=a("#"+a(this).attr("data-selecter-warp")),i=d.init(a("#ajax-loading-home-box-tpl").html());h.length<=0&&(h=a(this).parent().parent()),g&&(i=d.init(a("#ajax-loading-sub-tpl").html()));var j="写点评",k="写点评...",l=decodeURI(a(this).attr("data-username"))||"";if(f&&g){j="回复评论";var m=decodeURI(a(this).attr("data-content")).replace("\n","");m.length>20&&(m=m.substr(0,20)+"..."),k="回复 "+l+"："+m}var n=!1;this.hasAttribute("data-top-sub")&&(n=!0);var o=b.open({type:1,anim:"up",shade:!1,style:"position:absolute;top:0;left:0;width:100%;height:100%;",content:d.init(a("#input-replay-comment-tpl").html(),{header_title:j,default_title:k}),success:function(d,e){var j=!1,k=a(d).find("#input-replay-comment-send"),m=a(d).find("#input-replay-comment-warp-close");a(d).find(".layui-m-layercont").addClass("layui-m-layercont-my"),a(d).find("textarea").keyup(function(b){String(a(this).val()).replace(/^\s+|\s+$/,"")!==""?(j=!0,k.addClass("red").removeClass("gray")):(j=!1,k.addClass("gray").removeClass("red"))}),setTimeout(function(){a(d).find("textarea").focus()},1e3);var o=!1;a("#input-replay-comment-centent").click(function(){a(this).removeAttr("readonly")}).trigger("click"),k.click(function(){var e=String(a(d).find("#input-replay-comment-centent").val()).replace(/^\s+|\s+$/,"");if(e==""||!j){b.open({content:"请先填写内容",skin:"msg",time:1.5});return}if(o)return;o=!0,a.get("/api/comment/PostComment",{id:blogid,type:type,content:e,parent_id:f,commentid:g},function(d){if(d.resultCode==-100)c.login();else if(d.resultCode==0){a("body").css({height:"100%"});var j=i({data:[{uid:d.result.uid,username:d.result.username,content:e,add_time:"刚刚",avatar:d.result.avatar,praise:0,reply:0,replyuser:n?"":l?l:"replyuser"in d.result?d.result.replyuser:"",cid:d.result.cid,style:""}]}),k=h.find("li:first");h.parent().css("display")=="none"&&h.parent().show().find(".fire-loading").hide(),k.length?k.before(j):h.append(j);if(!f&&!g){var m=a("[data-dianping-number]");m.html(parseInt(m.html())+1)}b.open({content:"评论成功",skin:"msg",time:1,end:function(){b.closeAll(),o=!1}})}else b.open({content:d.errorMsg||"系统错误",skin:"msg",time:1,end:function(){o=!1}})},"json")}),m.click(function(){b.closeAll(),a("body").css({height:"100%"})})}})}),{getFirstComment:function(){a("[data-first-loading]").each(function(){h(a(this),!0,2),a(this).removeAttr("data-first-loading")})},praise:function(b){if(a(b).hasClass("on"))return;a.get("/api/praise/praise",{id_value:a(b).attr("cid"),status:"1",type:3},function(d){d.resultCode==0?a(b).addClass("on animate").html(parseInt(a(b).html())+1):d.resultCode==-100&&c.login()},"json")},replySub:function(b){g();var c=a(b).parent().next();window.commentSubView2.push(c),c.show()}}})
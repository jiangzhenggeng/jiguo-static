define(["jquery","cropper","layer"],function(a,b,c){var d=null;return{init:function(b,e,f){b=a(b).length?a(b):null,f=f||function(b){var c=b.result.pop();a(this).attr("src","http://s1.jiguo.com/"+c.fileid+"/640"),a(this).closest("li").find('input[type="hidden"]').val(c.fileid)},e=a.extend(!0,{boxWidth:700,boxHeight:645,aspectRatio:.5,preview:!0},e);if(!b)return;b.data("original-src")||b.data("original-src",b.attr("src"));var g=b.data("original-src");g.match(/https?:\/\/s1\.jiguo\.com\/([\w\-]+)\/?/i)?g="http://s1.jiguo.com/"+g.match(/https?:\/\/s1\.jiguo\.com\/([\w\-]+)\/?/i)[1]:g="http://zdm.jiguo.com/admin/index/ShowImgTool?url="+encodeURIComponent(g);var h=this,i="id-"+String(Math.random()).replace(".",""),j="preview-"+i,k=function(){var k=c.open({title:"图片裁剪",type:1,move:!0,btn:["确定","取消"],area:[e.boxWidth+"px",e.boxHeight+"px"],content:"						<style>.note-warp.event-page-notice {display: flex;flex-direction: row;}</style>						<style>.layui-layer-content{border-bottom: 1px solid #eee;}#warp-"+i+' img{display: block};</style>            <div class="note-warp event-page-notice" id="warp-'+i+'">            	<div style="flex: 1;width: 500px;height: 500px;"><img id="'+i+'" src="'+g+'"/></div>							<div style="width:150px;height:'+150/e.aspectRatio+'px;margin-left: 10px;overflow: hidden;box-shadow: 0 0 10px 5px rgba(0, 0, 0, 0.25), 0 0 0px 1px rgba(0, 0, 0, 0.11)" id="'+j+'"></div>            </div>',yes:function(e,g){if(!d||d.dataUploading)return;d.dataUploading=!0;var h=c.msg("数据上传中...",{time:9999999999}),j=d.getCroppedCanvas();j.toBlob(function(e){var g=new FormData;g.append("file0",e,i+".jpg");var j="http://zdm.jiguo.com/admin2/ajax/multipleupload";a.ajax(j,{method:"POST",data:g,processData:!1,contentType:!1,dataType:"json",success:function(a){a.resultCode==0?(c.close(k),f.call(b,a)):c.msg(a.errorMsg||"上传错误",{time:1500})},error:function(){c.msg("上传错误",{time:1500})},complete:function(){d.dataUploading=!1,c.close(h)}})})},success:function(){h.createCropper(a("#"+i),e,f,{preview:j})}})},l=new Image;l.onload=function(){m&&c.close(m),k()};var m=c.msg("数据加载中...",{time:9999999999});l.src=g},createCropper:function(c,e,f,g){var h="#"+g.preview,i=new b(a(c).get(0),{aspectRatio:e.aspectRatio,autoCropArea:1,movable:!1,ready:function(){if(e.preview){var b=this.cloneNode();b.className="",b.style.cssText="display: block;width: 100%;min-width: 0;min-height: 0;max-width: none;max-height: none;",this.previewDom=a(h),this.previewDom.each(function(){a(this).html(b.cloneNode())})}},crop:function(b){var c=b.detail,d=this.cropper,f=d.getImageData();if(f){var g=!1;c.y<0&&(c.y=0,g="y1"),c.y+c.height>f.naturalHeight&&(c.y=f.naturalHeight-c.height,g="y2"),c.x<0&&(c.x=0,g="x1"),c.x+c.width>f.naturalWidth&&(c.x=f.naturalWidth-c.width,g="x2"),c.height>f.naturalHeight&&(c.height=f.naturalHeight,g="h"),c.width>f.naturalWidth&&(c.width=f.naturalWidth,g="w");if(g){d.timer&&clearTimeout(d.timer),d.timer=setTimeout(function(){g=!1,d.setData(c)},30);return}}if(e.preview){var h=c.width/c.height;this.previewDom.each(function(){var b=a(this).get(0),d=b.getElementsByTagName("img").item(0),e=b.offsetWidth,g=e/h,i=c.width/e;b.style.height=g+"px",d.style.width=f.naturalWidth/i+"px",d.style.height=f.naturalHeight/i+"px",d.style.marginLeft=-c.x/i+"px",d.style.marginTop=-c.y/i+"px"})}}});d=i}}})
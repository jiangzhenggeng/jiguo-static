define(["jquery","app/common","template","app/tplEngine","layer","lib/html2canvas"],function(a,b,c,d,e){function f(a){var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d);for(var f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})}function g(a,b){var c=document.createElementNS("http://www.w3.org/1999/xhtml","a");c.href=a,c.download=b;var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)}function h(b){var c=document.getElementById("share-img-box"),d=c.offsetWidth,g=c.offsetHeight,h=document.createElement("canvas");h.width=d,h.height=g,h.style.width=d+"px",h.style.height=g+"px";var i=h.getContext("2d"),j=c.getBoundingClientRect().left,k=c.getBoundingClientRect().top;i.translate(-j,-k),html2canvas(c,{canvas:h,onrendered:function(c){var d=c.toDataURL("image/png",1).replace("image/jpeg","image/octet-stream"),g=(new Date).getDate()+String(Math.random()).replace("0.","")+".png",h=new FormData,i=f(d);h.append("file",i,g),a.ajax({type:"post",url:"/admin2/ajax/upload",data:h,dataType:"json",processData:!1,contentType:!1,success:function(c){c.resultCode==0?(a(".share-img").attr("src",c.result.url),a("#share_cover").val(c.result.fileid)):e.msg(c.errorMsg),(b||function(){})()}})}})}function i(){var b=a("#share-img-box"),c=!1,f,g,i;f=a("#share_title").val(),g=a("#share_desc").val(),i=a("#share_small_desc").val();if(f.trim().length<=0){e.msg("请填写分享标题");return}if(g.trim().length<=0){e.msg("请填写第一行文案");return}if(i.trim().length<=0){e.msg("请填写第二行文案");return}if(c)return;var j=e.msg("正在生成小程序分享图",{time:999999});c=!0,clearTimeout(k);var k=setTimeout(function(){c=!1},5e3),l={title:f,first_text:g,second_text:i},m=d.init(a("#coupon-wx-share-tpl").html(),l);b.html(m).find("img").load(function(){h(function(){e.close(j),c=!1,a(".share-title").html(l.title)})})}function j(){if(a("#name").val().length<=0)return e.msg("请输入名称"),!1;if(a("#price").val().length<=0)return e.msg("请输入金额"),!1;var b=a("#num").val();return b.length<=0?(e.msg("请输入券数量"),!1):b%1>0||b<=0?(e.msg("券数量请填写大于 0 的整数"),!1):a("#start_time").val().length<=0?(e.msg("请输入有效期开始时间"),!1):a("#push_day").val().length<=0?(e.msg("请输入push提醒时间"),!1):a("#ctitle").val().length<=0?(e.msg("请输入券标题"),!1):a("#cdesc").val().length<=0?(e.msg("请输入券简介"),!1):a("#cleftdesc").val().length<=0?(e.msg("请输入左侧文案"),!1):a("#crule").val().length<=0?(e.msg("请输入规则说明"),!1):a("#share_title").val().length<=0?(e.msg("请输入分享标题"),!1):a("#share_cover").val().length<=0?(e.msg("请生成小程序分享图"),!1):!0}function k(a){var b=new Date(a),c=b.getFullYear(),d=b.getMonth()+1,e=b.getDate();return c+"."+d+"."+e}return{submitForm:function(){if(!j())return;var b=e.load(3,{time:2e4}),c=a("#formData").serialize();a.ajax({type:"post",url:"/admin2/coupon/InsertCouponPackage",data:c,dataType:"json",timeout:1e4,complete:function(c,d){e.close(b);if(d=="timeout")e.msg("提交超时");else{var f=a.parseJSON(c.responseText);f.success!="true"?e.msg(f.errorMsg):e.msg(f.result,function(){location.href="/admin2/coupon/couponpackagelist"})}}})},showCard:function(){var b=a("#ctitle").val(),d=a("#cdesc").val(),e=a("#price").val(),f=a("#cleftdesc").val(),g=a("#crule").val(),h=k(a("#start_time").val()),i=k(a("#end_time").val()),j={ctitle:b,cdesc:d,price:e,cleftdesc:f,crule:g,startTime:h,endTime:i},l=c("preview-card-tpl",j);a(".coupon-card-wrapper").html(l)},updatePrice:function(){var b=this;a("#price").bind("input propertychange",function(){var c=a(this).val();a(".coupon-money").text(c),b.showCard()})},updateCard:function(){var b=this;a("#price,#ctitle,#cdesc,#cleftdesc").bind("input propertychange",function(){b.showCard()}),a("#start_time,#end_time").blur(function(){b.showCard()})},createShareImg:function(){a("body").on("click","[data-create-wxcode-share-pic]",function(){i()})}}})
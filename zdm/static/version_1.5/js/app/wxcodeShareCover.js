define(["jquery","layer","app/common","lib/html2canvas","app/tplEngine"],function(a,b,c,d,e){function f(a){var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d);for(var f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})}function g(a,b){var c=document.createElementNS("http://www.w3.org/1999/xhtml","a");c.href=a,c.download=b;var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)}function h(b,d){var e=document.getElementById("wxcode-share-inner"),g=e.offsetWidth,h=e.offsetHeight,i=document.createElement("canvas");i.width=g,i.height=h,i.style.width=g+"px",i.style.height=h+"px";var j=i.getContext("2d"),k=parseInt(a(e).parent().css("left")),n=parseInt(a(e).parent().css("top"));j.translate(-k,-n),html2canvas(e,{canvas:i,onrendered:function(e){var g=e.toDataURL("image/png",1).replace("image/jpeg","image/octet-stream"),h=(new Date).getDate()+String(Math.random()).replace("0.","")+".png",i=new FormData,j=f(g);i.append("file",j,h);var k="wxcode_share_pic";l=a("#Z-image-up-wxcode_share_pic li").length||l,d&&l>1||m?(a("#Z-image-up-wxcode_share_pic").html(""),l=0,m=!1):d&&l===1&&(k="wxcode_share_pic_before"),c.upload.cropper='<div class="setting-query-wrap"><div class="cropper" data-aspect-ratio="750/600">裁剪</div></div>',c.upload(i,a("#Z-image-up-wxcode_share_pic"),k,d,function(){(b||function(){})()}),l++,c.upload.cropper=null}})}function i(a,b){a.tId&&clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},0)}function j(c){var d=a("#Z-image-up-fengmian"),f=e.init(a("#wxcode-share-inner-tpl").html()),g=a("#wxcode-share-inner"),j=a("#Z-image-up-wxcode_share_pic"),k=j.offset().top,l=a("#add-event-free-block"),n=a("#add-event-pay-block"),o=!1,p=!1,q=function(){if(o)return;var e=b.msg("正在生成小程序分享图",{time:999999});o=!0,setTimeout(function(){o=!1},5e3);var i,j,k,m,q;i="",j="",k="",m="",q="";if(l.find("input[type=hidden]").length>5&&n.find("input[type=hidden]").length<=0)i="立即申请",j=l.find('input[name*="buying_name"]').val(),m="限"+l.find("[data-all-number]").attr("data-all-number")+l.find('input[name*="quantifier"]').val(),k="免费",q="原价 ￥"+l.find('input[name*="buying_price"]').val(),l.find('input[name*="all_user"]').val()!=1&&l.find('input[name*="all_platform"]').val()!=1;else if(n.find(".Z-card-title").length>1){i="立即试用";var r=n.find(".Z-card-list-box").first(),s=r.find('input[name*="discount"]').val(),t=0;n.find(".Z-card-list-box").each(function(){a(this).find('input[name*="is_reserve"]').val()==1&&(p=!0);if(a(this).find('input[name*="[pc]"]').val()==1&&a(this).find('input[name*="[h5]"]').val()==1){var b=a(this).find('input[name*="discount"]').val();b&&s>b&&(r=a(this),s=b);var c=parseInt(a(this).find("[data-all-number]").attr("data-all-number"));!isNaN(c)&&c>0&&(t+=c)}}),t>0&&(s=String(s||"").replace(/\.0+$/,""),j=s+"折试用起",m="限"+t+r.find('input[name*="quantifier"]').val(),k="￥"+r.find(".yan-number.Z-red").html(),q="原价 "+r.find(".card-number .Z-gray").html())}else{i="立即试用";var r=n.find(".Z-card-list-box").first(),s=String(r.find('input[name*="discount"]').val()||"").replace(/\.0+$/,"");r.find('input[name*="is_reserve"]').val()==1&&(p=!0),j=s+"折试用",m="限"+r.find("[data-all-number]").attr("data-all-number")+r.find('input[name*="quantifier"]').val(),k="￥"+r.find(".yan-number.Z-red").html(),q="原价 "+r.find(".card-number .Z-gray").html()}if(!i||!j||!k||!m||!q){a("#Z-image-up-wxcode_share_pic").html('<input type="hidden" name="wxcode_share_pic" value="">'),b.msg("没有小程序分享图");return}var u=f({share_cover:d.find('input[name="fileid"]').val(),btn_text:i,left_top:j,left_bottom:k,right_top:m,right_bottom:q});g.html(u).find("img").load(function(){h(function(){b.close(e),o=!1,(c||function(){})()},p),p&&(u=f({share_cover:d.find('input[name="fileid"]').val(),btn_text:"立即预约",left_top:j,left_bottom:k,right_top:"",right_bottom:q}),g.html(u),h(function(){b.close(e),o=!1,(c||function(){})()},p))})};a("body").off("click.a").on("click.a","[data-create-wxcode-share-pic]",function(){a("#Z-image-up-fengmian").find("img").val()?b.msg("请上传封面图"):i(q,this),m=!0})}function k(b){j(b),a("[data-create-wxcode-share-pic]").trigger("click")}var l=0,m;return c.upImage("wxcode_share_pic","wxcode_share_pic",!1),{init:j,create:k}})
define(["jquery","layer","app/common","lib/html2canvas","app/tplEngine"],function(a,b,c,d,e){function h(a){var b=atob(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d);for(var f=0;f<b.length;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:c})}function i(a,b){var c=document.createElementNS("http://www.w3.org/1999/xhtml","a");c.href=a,c.download=b;var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)}function j(b,d){var e=document.getElementById("wxcode-share-inner"),i=e.offsetWidth,j=e.offsetHeight,k=document.createElement("canvas");k.width=i,k.height=j,k.style.width=i+"px",k.style.height=j+"px";var l=k.getContext("2d"),m=parseInt(a(e).parent().css("left")),n=parseInt(a(e).parent().css("top"));l.translate(-m,-n),html2canvas(e,{canvas:k,onrendered:function(e){var i=e.toDataURL("image/png",1).replace("image/jpeg","image/octet-stream"),j=(new Date).getDate()+String(Math.random()).replace("0.","")+".png",k=new FormData,l=h(i);k.append("file",l,j);var m="wxcode_share_pic";f=a("#Z-image-up-wxcode_share_pic li").length||f,d&&f>1||g?(a("#Z-image-up-wxcode_share_pic").html(""),f=0,g=!1):d&&f===1&&(m="wxcode_share_pic_before"),c.upload.cropper='<div class="setting-query-wrap"><div class="cropper" data-aspect-ratio="750/600">裁剪</div></div>',c.upload(k,a("#Z-image-up-wxcode_share_pic"),m,d,function(){(b||function(){})()}),f++,c.upload.cropper=null}})}function k(a,b){a.tId&&clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},0)}function l(c){var d=a("#Z-image-up-fengmian"),f=e.init(a("#wxcode-share-inner-tpl").html()),h=a("#wxcode-share-inner"),i=a("#Z-image-up-wxcode_share_pic"),l=i.offset().top,m=a("#add-event-free-block"),n=a("#add-event-pay-block"),o=!1,p=!1,q=function(){if(o)return;var e=b.msg("正在生成小程序分享图",{time:999999});o=!0,setTimeout(function(){o=!1},5e3);var g,i,k,l,q;g="",i="",k="",l="",q="";if(m.find("input[type=hidden]").length>5&&n.find("input[type=hidden]").length<=0)g="立即申请",i=m.find('input[name*="buying_name"]').val(),l="限"+m.find("[data-all-number]").attr("data-all-number")+m.find('input[name*="quantifier"]').val(),k="免费",q="原价 ￥"+m.find('input[name*="buying_price"]').val(),m.find('input[name*="all_user"]').val()!=1&&m.find('input[name*="all_platform"]').val()!=1;else if(n.find(".Z-card-title").length>1){g="立即试用";var r=n.find(".Z-card-list-box").first(),s=r.find('input[name*="discount"]').val(),t=0;n.find(".Z-card-list-box").each(function(){a(this).find('input[name*="is_reserve"]').val()==1&&(p=!0);if(a(this).find('input[name*="[pc]"]').val()==1&&a(this).find('input[name*="[h5]"]').val()==1){var b=a(this).find('input[name*="discount"]').val();b&&s>b&&(r=a(this),s=b);var c=parseInt(a(this).find("[data-all-number]").attr("data-all-number"));!isNaN(c)&&c>0&&(t+=c)}}),t>0&&(s=String(s||"").replace(/\.0+$/,""),i=s+"折试用起",l="限"+t+r.find('input[name*="quantifier"]').val(),k="￥"+r.find(".yan-number.Z-red").html(),q="原价 "+r.find(".card-number .Z-gray").html())}else{g="立即试用";var r=n.find(".Z-card-list-box").first(),s=String(r.find('input[name*="discount"]').val()||"").replace(/\.0+$/,"");r.find('input[name*="is_reserve"]').val()==1&&(p=!0),i=s+"折试用",l="限"+r.find("[data-all-number]").attr("data-all-number")+r.find('input[name*="quantifier"]').val(),k="￥"+r.find(".yan-number.Z-red").html(),q="原价 "+r.find(".card-number .Z-gray").html()}if(!g||!i||!k||!l||!q){a("#Z-image-up-wxcode_share_pic").html('<input type="hidden" name="wxcode_share_pic" value="">'),b.msg("没有小程序分享图");return}var u=f({share_cover:d.find('input[name="fileid"]').val(),btn_text:g,left_top:i,left_bottom:k,right_top:l,right_bottom:q});h.html(u).find("img").load(function(){j(function(){b.close(e),o=!1,(c||function(){})()},p),p&&(u=f({share_cover:d.find('input[name="fileid"]').val(),btn_text:"立即预约",left_top:i,left_bottom:k,right_top:"",right_bottom:q}),h.html(u),j(function(){b.close(e),o=!1,(c||function(){})()},p))})};a("body").off("click.a").on("click.a","[data-create-wxcode-share-pic]",function(){a("#Z-image-up-fengmian").find("img").val()?b.msg("请上传封面图"):k(q,this),g=!0})}function m(b){l(b),a("[data-create-wxcode-share-pic]").trigger("click")}var f=0,g;return c.upImage("wxcode_share_pic","wxcode_share_pic",!1),{init:l,create:m}})
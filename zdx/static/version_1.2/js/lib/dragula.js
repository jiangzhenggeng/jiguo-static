function dragula(a,b){function s(a){return r.containers.indexOf(a)!==-1||q.isContainer(a)}function t(a){var b=a?"remove":"add";touchy(documentElement,b,"mousedown",y),touchy(documentElement,b,"mouseup",H)}function u(a){var b=a?"remove":"add";touchy(documentElement,b,"mousemove",z)}function v(a){var b=a?"remove":"add";crossvent[b](documentElement,"selectstart",x),crossvent[b](documentElement,"click",x)}function w(){t(!0),H({})}function x(a){p&&a.preventDefault()}function y(a){i=a.clientX,j=a.clientY;var b=whichMouseButton(a)!==1||a.metaKey||a.ctrlKey;if(b)return;var c=a.target,d=A(c);if(!d)return;p=d,u(),a.type==="mousedown"&&(isInput(c)?c.focus():a.preventDefault())}function z(a){if(!p)return;if(whichMouseButton(a)===0){H({});return}if(a.clientX!==void 0&&a.clientX===i&&a.clientY!==void 0&&a.clientY===j)return;if(q.ignoreInputTextSelection){var b=getCoord("clientX",a),c=getCoord("clientY",a),d=doc.elementFromPoint(b,c);if(isInput(d))return}var e=p;u(!0),v(),F(),D(e);var k=getOffset(f);g=getCoord("pageX",a)-k.left,h=getCoord("pageY",a)-k.top,classes.add(m||f,"gu-transit"),R(),O(a)}function A(a){if(r.dragging&&d)return;if(s(a))return;var b=a;while(getParent(a)&&s(getParent(a))===!1){if(q.invalid(a,b))return;a=getParent(a);if(!a)return}var c=getParent(a);if(!c)return;if(q.invalid(a,b))return;var e=q.moves(a,c,b,nextEl(a));if(!e)return;return{item:a,source:c}}function B(a){return!!A(a)}function C(a){var b=A(a);b&&D(b)}function D(a){V(a.item,a.source)&&(m=a.item.cloneNode(!0),r.emit("cloned",m,a.item,"copy")),e=a.source,f=a.item,k=l=nextEl(a.item),r.dragging=!0,r.emit("drag",f,e)}function E(){return!1}function F(){if(!r.dragging)return;var a=m||f;I(a,getParent(a))}function G(){p=!1,u(!0),v(!0)}function H(a){G();if(!r.dragging)return;var b=m||f,c=getCoord("clientX",a),g=getCoord("clientY",a),h=getElementBehindPoint(d,c,g),i=N(h,c,g);i&&(m&&q.copySortSource||!m||i!==e)?I(b,i):q.removeOnSpill?J():K()}function I(a,b){var c=getParent(a);m&&q.copySortSource&&b===e&&c.removeChild(f),M(b)?r.emit("cancel",a,e,e):r.emit("drop",a,b,e,l),L()}function J(){if(!r.dragging)return;var a=m||f,b=getParent(a);b&&b.removeChild(a),r.emit(m?"cancel":"remove",a,b,e),L()}function K(a){if(!r.dragging)return;var b=arguments.length>0?a:q.revertOnSpill,c=m||f,d=getParent(c),g=M(d);g===!1&&b&&(m?d&&d.removeChild(m):e.insertBefore(c,k)),g||b?r.emit("cancel",c,e,e):r.emit("drop",c,d,e,l),L()}function L(){var a=m||f;G(),S(),a&&classes.rm(a,"gu-transit"),n&&clearTimeout(n),r.dragging=!1,o&&r.emit("out",a,o,e),r.emit("dragend",a),e=f=m=k=l=n=o=null}function M(a,b){var c;return b!==void 0?c=b:d?c=l:c=nextEl(m||f),a===e&&c===k}function N(a,b,c){function g(){var g=s(d);if(g===!1)return!1;var h=T(d,a),i=U(d,h,b,c),j=M(d,i);return j?!0:q.accepts(f,d,e,i)}var d=a;while(d&&!g())d=getParent(d);return d}function O(a){function x(a){r.emit(a,n,o,e)}function y(){t&&x("over")}function z(){o&&x("out")}if(!d)return;a.preventDefault();var b=getCoord("clientX",a),c=getCoord("clientY",a),i=b-g,j=c-h;d.style.left=i+"px",d.style.top=j+"px";var n=m||f,p=getElementBehindPoint(d,b,c),s=N(p,b,c),t=s!==null&&s!==o;if(t||s===null)z(),o=s,y();var u=getParent(n);if(s===e&&m&&!q.copySortSource){u&&u.removeChild(n);return}var v,w=T(s,p);if(w!==null)v=U(s,w,b,c);else{if(q.revertOnSpill!==!0||!!m){m&&u&&u.removeChild(n);return}v=k,s=e}if(v===null&&t||v!==n&&v!==nextEl(n))l=v,s.insertBefore(n,v),r.emit("shadow",n,s,e)}function P(a){classes.rm(a,"gu-hide")}function Q(a){r.dragging&&classes.add(a,"gu-hide")}function R(){if(d)return;var a=f.getBoundingClientRect();d=f.cloneNode(!0),d.style.width=getRectWidth(a)+"px",d.style.height=getRectHeight(a)+"px",classes.rm(d,"gu-transit"),classes.add(d,"gu-mirror"),q.mirrorContainer.appendChild(d),touchy(documentElement,"add","mousemove",O),classes.add(q.mirrorContainer,"gu-unselectable"),r.emit("cloned",d,f,"mirror")}function S(){d&&(classes.rm(q.mirrorContainer,"gu-unselectable"),touchy(documentElement,"remove","mousemove",O),getParent(d).removeChild(d),d=null)}function T(a,b){var c=b;while(c!==a&&getParent(c)!==a)c=getParent(c);return c===documentElement?null:c}function U(a,b,c,d){function g(){var b=a.children.length,f,g,h;for(f=0;f<b;f++){g=a.children[f],h=g.getBoundingClientRect();if(e&&h.left+h.width/2>c)return g;if(!e&&h.top+h.height/2>d)return g}return null}function h(){var a=b.getBoundingClientRect();return e?i(c>a.left+getRectWidth(a)/2):i(d>a.top+getRectHeight(a)/2)}function i(a){return a?nextEl(b):b}var e=q.direction==="horizontal",f=b!==a?h():g();return f}function V(a,b){return typeof q.copy=="boolean"?q.copy:q.copy(a,b)}var c=arguments.length;c===1&&Array.isArray(a)===!1&&(b=a,a=[]);var d,e,f,g,h,i,j,k,l,m,n,o=null,p,q=b||{};q.moves===void 0&&(q.moves=always),q.accepts===void 0&&(q.accepts=always),q.invalid===void 0&&(q.invalid=E),q.containers===void 0&&(q.containers=a||[]),q.isContainer===void 0&&(q.isContainer=never),q.copy===void 0&&(q.copy=!1),q.copySortSource===void 0&&(q.copySortSource=!1),q.revertOnSpill===void 0&&(q.revertOnSpill=!1),q.removeOnSpill===void 0&&(q.removeOnSpill=!1),q.direction===void 0&&(q.direction="vertical"),q.ignoreInputTextSelection===void 0&&(q.ignoreInputTextSelection=!0),q.mirrorContainer===void 0&&(q.mirrorContainer=doc.body);var r=emitter({containers:q.containers,start:C,end:F,cancel:K,remove:J,destroy:w,canMove:B,dragging:!1});return q.removeOnSpill===!0&&r.on("over",P).on("out",Q),t(),r}function touchy(a,b,c,d){var e={mouseup:"touchend",mousedown:"touchstart",mousemove:"touchmove"},f={mouseup:"pointerup",mousedown:"pointerdown",mousemove:"pointermove"},g={mouseup:"MSPointerUp",mousedown:"MSPointerDown",mousemove:"MSPointerMove"};global.navigator.pointerEnabled?crossvent[b](a,f[c],d):global.navigator.msPointerEnabled?crossvent[b](a,g[c],d):(crossvent[b](a,e[c],d),crossvent[b](a,c,d))}function whichMouseButton(a){if(a.touches!==void 0)return a.touches.length;if(a.which!==void 0&&a.which!==0)return a.which;if(a.buttons!==void 0)return a.buttons;var b=a.button;if(b!==void 0)return b&1?1:b&2?3:b&4?2:0}function getOffset(a){var b=a.getBoundingClientRect();return{left:b.left+getScroll("scrollLeft","pageXOffset"),top:b.top+getScroll("scrollTop","pageYOffset")}}function getScroll(a,b){return typeof global[b]!="undefined"?global[b]:documentElement.clientHeight?documentElement[a]:doc.body[a]}function getElementBehindPoint(a,b,c){var d=a||{},e=d.className,f;return d.className+=" gu-hide",f=doc.elementFromPoint(b,c),d.className=e,f}function never(){return!1}function always(){return!0}function getRectWidth(a){return a.width||a.right-a.left}function getRectHeight(a){return a.height||a.bottom-a.top}function getParent(a){return a.parentNode===doc?null:a.parentNode}function isInput(a){return a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||isEditable(a)}function isEditable(a){return a?a.contentEditable==="false"?!1:a.contentEditable==="true"?!0:isEditable(getParent(a)):!1}function nextEl(a){function b(){var b=a;do b=b.nextSibling;while(b&&b.nodeType!==1);return b}return a.nextElementSibling||b()}function getEventHost(a){return a.targetTouches&&a.targetTouches.length?a.targetTouches[0]:a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:a}function getCoord(a,b){var c=getEventHost(b),d={pageX:"clientX",pageY:"clientY"};return a in d&&!(a in c)&&d[a]in c&&(a=d[a]),c[a]}var emitter=require("contra/emitter"),crossvent=require("crossvent"),classes=require("./classes"),doc=document,documentElement=doc.documentElement;module.exports=dragula
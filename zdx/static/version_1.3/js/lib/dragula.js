function dragula(a,b){function c(a){return V.containers.indexOf(a)!==-1||U.isContainer(a)}function d(a){var b=a?"remove":"add";touchy(documentElement,b,"mousedown",i),touchy(documentElement,b,"mouseup",r)}function e(a){var b=a?"remove":"add";touchy(documentElement,b,"mousemove",j)}function f(a){var b=a?"remove":"add";crossvent[b](documentElement,"selectstart",h),crossvent[b](documentElement,"click",h)}function g(){d(!0),r({})}function h(a){T&&a.preventDefault()}function i(a){M=a.clientX,N=a.clientY;var b=whichMouseButton(a)!==1||a.metaKey||a.ctrlKey;if(b)return;var c=a.target,d=k(c);if(!d)return;T=d,e(),a.type==="mousedown"&&(isInput(c)?c.focus():a.preventDefault())}function j(a){if(!T)return;if(whichMouseButton(a)===0){r({});return}if(a.clientX!==void 0&&a.clientX===M&&a.clientY!==void 0&&a.clientY===N)return;if(U.ignoreInputTextSelection){var b=getCoord("clientX",a),c=getCoord("clientY",a),d=doc.elementFromPoint(b,c);if(isInput(d))return}var g=T;e(!0),f(),p(),n(g);var h=getOffset(J);K=getCoord("pageX",a)-h.left,L=getCoord("pageY",a)-h.top,classes.add(Q||J,"gu-transit"),B(),y(a)}function k(a){if(V.dragging&&H)return;if(c(a))return;var b=a;while(getParent(a)&&c(getParent(a))===!1){if(U.invalid(a,b))return;a=getParent(a);if(!a)return}var d=getParent(a);if(!d)return;if(U.invalid(a,b))return;var e=U.moves(a,d,b,nextEl(a));if(!e)return;return{item:a,source:d}}function l(a){return!!k(a)}function m(a){var b=k(a);b&&n(b)}function n(a){F(a.item,a.source)&&(Q=a.item.cloneNode(!0),V.emit("cloned",Q,a.item,"copy")),I=a.source,J=a.item,O=P=nextEl(a.item),V.dragging=!0,V.emit("drag",J,I)}function o(){return!1}function p(){if(!V.dragging)return;var a=Q||J;s(a,getParent(a))}function q(){T=!1,e(!0),f(!0)}function r(a){q();if(!V.dragging)return;var b=Q||J,c=getCoord("clientX",a),d=getCoord("clientY",a),e=getElementBehindPoint(H,c,d),f=x(e,c,d);f&&(Q&&U.copySortSource||!Q||f!==I)?s(b,f):U.removeOnSpill?t():u()}function s(a,b){var c=getParent(a);Q&&U.copySortSource&&b===I&&c.removeChild(J),w(b)?V.emit("cancel",a,I,I):V.emit("drop",a,b,I,P),v()}function t(){if(!V.dragging)return;var a=Q||J,b=getParent(a);b&&b.removeChild(a),V.emit(Q?"cancel":"remove",a,b,I),v()}function u(a){if(!V.dragging)return;var b=arguments.length>0?a:U.revertOnSpill,c=Q||J,d=getParent(c),e=w(d);e===!1&&b&&(Q?d&&d.removeChild(Q):I.insertBefore(c,O)),e||b?V.emit("cancel",c,I,I):V.emit("drop",c,d,I,P),v()}function v(){var a=Q||J;q(),C(),a&&classes.rm(a,"gu-transit"),R&&clearTimeout(R),V.dragging=!1,S&&V.emit("out",a,S,I),V.emit("dragend",a),I=J=Q=O=P=R=S=null}function w(a,b){var c;return b!==void 0?c=b:H?c=P:c=nextEl(Q||J),a===I&&c===O}function x(a,b,d){function e(){var e=c(f);if(e===!1)return!1;var g=D(f,a),h=E(f,g,b,d),i=w(f,h);return i?!0:U.accepts(J,f,I,h)}var f=a;while(f&&!e())f=getParent(f);return f}function y(a){function b(a){V.emit(a,i,S,I)}function c(){l&&b("over")}function d(){S&&b("out")}if(!H)return;a.preventDefault();var e=getCoord("clientX",a),f=getCoord("clientY",a),g=e-K,h=f-L;H.style.left=g+"px",H.style.top=h+"px";var i=Q||J,j=getElementBehindPoint(H,e,f),k=x(j,e,f),l=k!==null&&k!==S;if(l||k===null)d(),S=k,c();var m=getParent(i);if(k===I&&Q&&!U.copySortSource){m&&m.removeChild(i);return}var n,o=D(k,j);if(o!==null)n=E(k,o,e,f);else{if(U.revertOnSpill!==!0||!!Q){Q&&m&&m.removeChild(i);return}n=O,k=I}if(n===null&&l||n!==i&&n!==nextEl(i))P=n,k.insertBefore(i,n),V.emit("shadow",i,k,I)}function z(a){classes.rm(a,"gu-hide")}function A(a){V.dragging&&classes.add(a,"gu-hide")}function B(){if(H)return;var a=J.getBoundingClientRect();H=J.cloneNode(!0),H.style.width=getRectWidth(a)+"px",H.style.height=getRectHeight(a)+"px",classes.rm(H,"gu-transit"),classes.add(H,"gu-mirror"),U.mirrorContainer.appendChild(H),touchy(documentElement,"add","mousemove",y),classes.add(U.mirrorContainer,"gu-unselectable"),V.emit("cloned",H,J,"mirror")}function C(){H&&(classes.rm(U.mirrorContainer,"gu-unselectable"),touchy(documentElement,"remove","mousemove",y),getParent(H).removeChild(H),H=null)}function D(a,b){var c=b;while(c!==a&&getParent(c)!==a)c=getParent(c);return c===documentElement?null:c}function E(a,b,c,d){function e(){var b=a.children.length,e,f,g;for(e=0;e<b;e++){f=a.children[e],g=f.getBoundingClientRect();if(h&&g.left+g.width/2>c)return f;if(!h&&g.top+g.height/2>d)return f}return null}function f(){var a=b.getBoundingClientRect();return h?g(c>a.left+getRectWidth(a)/2):g(d>a.top+getRectHeight(a)/2)}function g(a){return a?nextEl(b):b}var h=U.direction==="horizontal",i=b!==a?f():e();return i}function F(a,b){return typeof U.copy=="boolean"?U.copy:U.copy(a,b)}var G=arguments.length;G===1&&Array.isArray(a)===!1&&(b=a,a=[]);var H,I,J,K,L,M,N,O,P,Q,R,S=null,T,U=b||{};U.moves===void 0&&(U.moves=always),U.accepts===void 0&&(U.accepts=always),U.invalid===void 0&&(U.invalid=o),U.containers===void 0&&(U.containers=a||[]),U.isContainer===void 0&&(U.isContainer=never),U.copy===void 0&&(U.copy=!1),U.copySortSource===void 0&&(U.copySortSource=!1),U.revertOnSpill===void 0&&(U.revertOnSpill=!1),U.removeOnSpill===void 0&&(U.removeOnSpill=!1),U.direction===void 0&&(U.direction="vertical"),U.ignoreInputTextSelection===void 0&&(U.ignoreInputTextSelection=!0),U.mirrorContainer===void 0&&(U.mirrorContainer=doc.body);var V=emitter({containers:U.containers,start:m,end:p,cancel:u,remove:t,destroy:g,canMove:l,dragging:!1});return U.removeOnSpill===!0&&V.on("over",z).on("out",A),d(),V}function touchy(a,b,c,d){var e={mouseup:"touchend",mousedown:"touchstart",mousemove:"touchmove"},f={mouseup:"pointerup",mousedown:"pointerdown",mousemove:"pointermove"},g={mouseup:"MSPointerUp",mousedown:"MSPointerDown",mousemove:"MSPointerMove"};global.navigator.pointerEnabled?crossvent[b](a,f[c],d):global.navigator.msPointerEnabled?crossvent[b](a,g[c],d):(crossvent[b](a,e[c],d),crossvent[b](a,c,d))}function whichMouseButton(a){if(a.touches!==void 0)return a.touches.length;if(a.which!==void 0&&a.which!==0)return a.which;if(a.buttons!==void 0)return a.buttons;var b=a.button;if(b!==void 0)return b&1?1:b&2?3:b&4?2:0}function getOffset(a){var b=a.getBoundingClientRect();return{left:b.left+getScroll("scrollLeft","pageXOffset"),top:b.top+getScroll("scrollTop","pageYOffset")}}function getScroll(a,b){return typeof global[b]!="undefined"?global[b]:documentElement.clientHeight?documentElement[a]:doc.body[a]}function getElementBehindPoint(a,b,c){var d=a||{},e=d.className,f;return d.className+=" gu-hide",f=doc.elementFromPoint(b,c),d.className=e,f}function never(){return!1}function always(){return!0}function getRectWidth(a){return a.width||a.right-a.left}function getRectHeight(a){return a.height||a.bottom-a.top}function getParent(a){return a.parentNode===doc?null:a.parentNode}function isInput(a){return a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||isEditable(a)}function isEditable(a){return a?a.contentEditable==="false"?!1:a.contentEditable==="true"?!0:isEditable(getParent(a)):!1}function nextEl(a){function b(){var b=a;do b=b.nextSibling;while(b&&b.nodeType!==1);return b}return a.nextElementSibling||b()}function getEventHost(a){return a.targetTouches&&a.targetTouches.length?a.targetTouches[0]:a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:a}function getCoord(a,b){var c=getEventHost(b),d={pageX:"clientX",pageY:"clientY"};return a in d&&!(a in c)&&d[a]in c&&(a=d[a]),c[a]}var emitter=require("contra/emitter"),crossvent=require("crossvent"),classes=require("./classes"),doc=document,documentElement=doc.documentElement;module.exports=dragula